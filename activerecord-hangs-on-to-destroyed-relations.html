<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta http-equiv="Content-Language" content="en-us"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="keywords" content=""/>
  <meta name="description" content=""/>
  <title>ActiveRecord Hangs On to Destroyed Relations - My Kind of Stupid</title>
  <link type="application/atom+xml" href="/feed.xml" rel="alternate" title="Articles"/>
  <link type="image/vnd.microsoft.icon" href="/favicon.ico" rel="icon"/>
  <link type="text/css" href="/stylesheets/application.css" rel="stylesheet"/>
  
</head>
<body>
  <header>
    <div class="container">
      <hgroup>
        <h1><a href="/" class="title">My Kind of Stupid</a></h1>
        <h2>Web development, user interfaces, and other development topics.</h2>
      </hgroup>
      <nav>
        <ul class="nav-list">
          <li><a href="/">Articles</a></li>
          <li><a href="http://adamstegman.com/">Adam Stegman</a></li>
          <li><a rel="me" href="http://twitter.com/adamstegman">Twitter</a></li>
          <li><a rel="me" href="http://github.com/adamstegman">Github</a></li>
      </nav>
    </div>
  </header>
  <div class="content">
    <div class="container">
      <article itemscope="true" itemtype="http://www.schema.org/BlogPosting">
        <header>
          <hgroup>
            
            <h2 itemprop="name">ActiveRecord Hangs On to Destroyed Relations</h2>
            
            
          </hgroup>
        </header>
        <div class="article-body" itemprop="articleBody">
          <p>Rails&#8217; ActiveRecord has a nifty #destroy method that almost everyone already knows about. The documentation for #destroy <sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> <sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup> helpfully states</p>

<blockquote>
<p>Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can’t be persisted).</p>
</blockquote>

<p>What is less clear is how it works when you call it on a relationship. To be sure, it destroyed the database record. What it also unfortunately does it hangs on to the reference in the parent object.</p>

<p>Let&#8217;s throw down with some sample code.</p>

<pre><code>class Thing &lt; ActiveRecord::Base
  has_one :child
end

class Child &lt; ActiveRecord::Base
  belongs_to :thing
end

zengarden&gt; thing = Thing.new
th=&gt; #&lt;Thing id: nil, name: nil, created_at: nil, updated_at: nil&gt;
zengarden&gt; thing.save
=&gt; true
zengarden&gt; thing.create_child :name =&gt; &quot;Child&quot;
=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1,...&gt;
zengarden&gt; thing.child
=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1...&gt;
zengarden&gt; thing.child.destroy
=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1...&gt;
zengarden&gt; thing.child
=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1...&gt;</code></pre>

<p>Arg. I just destroyed it! I don&#8217;t want it hanging around in my cache. If I really wanted to save it, I should have saved it before or during the destroy call. I can of course invalidate my cache by calling</p>

<pre><code>thing.child(true)</code></pre>

<p>which correctly returns nil. But if I don&#8217;t know to do that immediately after the destroy, I get errors like</p>

<blockquote>
<p>TypeError: can&#8217;t modify frozen hash</p>
</blockquote>

<p>because code used later naïvely calls</p>

<pre><code>if thing.child
  thing.child.attributes = new_attributes
end</code></pre>

<p>expecting that if a child exists, it should be updated.</p>

<p>For the sake of argument, let&#8217;s say that maybe the behavior isn&#8217;t so bad, maybe this is what people expect or could use. In that case, what a terrible error message. I&#8217;m not familiar enough with the Associations internals to suggest where a better one could be injected, but something along the lines of</p>

<blockquote>
<p>Can&#8217;t modify a destroyed record</p>
</blockquote>

<p>would be miles better.</p>
<div class='footnotes'><hr /><ol><li id='fn:1'>
<p>Rails 3 - <a href='http://railsapi.com/doc/rails-v3.0.0/classes/ActiveRecord/Persistence.html#M001019'>http://railsapi.com/doc/rails-v3.0.0/classes/ActiveRecord/Persistence.html#M001019</a></p>
<a href='#fnref:1' rev='footnote'>&#8617;</a></li><li id='fn:2'>
<p>Rails 2.3.8 - <a href='http://railsapi.com/doc/rails-v2.3.8/classes/ActiveRecord/Base.html#M001111'>http://railsapi.com/doc/rails-v2.3.8/classes/ActiveRecord/Base.html#M001111</a></p>
<a href='#fnref:2' rev='footnote'>&#8617;</a></li></ol></div>
        </div>
        <footer>
          <div class="published">
            Published at
            <time datetime="2010-10-25T18:31Z" pubdate="true" itemprop="datePublished">
              October 25, 2010, 1:31 pm
            </time>
          </div>
        </footer>
      </article>
    </div>
  </div>
  <footer>
    <div class="container">
      <section class="author">
        <h2>
          Written by
          <a rel="author" href="http://adamstegman.com/">Adam Stegman</a>
        </h2>
        <ul class="contact">
          <li>
            <a href="http://twitter.com/adamstegman">Follow me on Twitter</a>
          </li>
          <li>
            <a href="http://github.com/adamstegman">Follow me on Github</a>
          </li>
          <li>
            <a href="http://profiles.google.com/adam.stegman">Google Profile</a>
          </li>
          <li>
            <a href="mailto:me@adamstegman.com">Email me</a>
          </li>
        </ul>
      </section>
    </div>
  </footer>
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24951237-1']);
    _gaq.push(['_setDomainName', '.adamstegman.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body>
</html>
