<!DOCTYPE html>
<html>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta content='en-us' http-equiv='Content-Language'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta name='keywords'>
    <meta name='description'>
    <title>ActiveRecord Hangs On to Destroyed Relations - My Kind of Stupid</title>
    <link href='/feed.xml' rel='alternate' title='Articles' type='application/atom+xml'>
    <link href='/favicon.ico' rel='icon' type='image/vnd.microsoft.icon'>
    <link href='/stylesheets/application.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <header>
      <div class='container'>
        <hgroup>
          <h1>
            <a class='title' href='/'>My Kind of Stupid</a>
          </h1>
          <h2>Web development, user interfaces, and other development topics.</h2>
        </hgroup>
        <nav>
          <ul class='nav-list'>
            <li>
              <a href='/'>Articles</a>
            </li>
            <li>
              <a href='http://adamstegman.com/'>Adam Stegman</a>
            </li>
            <li>
              <a href='http://twitter.com/adamstegman' rel='me'>Twitter</a>
            </li>
            <li>
              <a href='http://github.com/adamstegman' rel='me'>Github</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <div class='content'>
      <div class='container'>
        <article itemscope itemtype='http://www.schema.org/BlogPosting'>
          <header>
            <hgroup>
              <h2 itemprop='name'>ActiveRecord Hangs On to Destroyed Relations</h2>
            </hgroup>
          </header>
          <div class='article-body' itemprop='articleBody'>
            <p>Rails&#8217; ActiveRecord has a nifty #destroy method that almost everyone already knows about. The documentation for #destroy <sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> <sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup> helpfully states</p>&#x000A;&#x000A;<blockquote>&#x000A;<p>Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can’t be persisted).</p>&#x000A;</blockquote>&#x000A;&#x000A;<p>What is less clear is how it works when you call it on a relationship. To be sure, it destroyed the database record. What it also unfortunately does it hangs on to the reference in the parent object.</p>&#x000A;&#x000A;<p>Let&#8217;s throw down with some sample code.</p>&#x000A;&#x000A;<pre><code>class Thing &lt; ActiveRecord::Base&#x000A;  has_one :child&#x000A;end&#x000A;&#x000A;class Child &lt; ActiveRecord::Base&#x000A;  belongs_to :thing&#x000A;end&#x000A;&#x000A;zengarden&gt; thing = Thing.new&#x000A;th=&gt; #&lt;Thing id: nil, name: nil, created_at: nil, updated_at: nil&gt;&#x000A;zengarden&gt; thing.save&#x000A;=&gt; true&#x000A;zengarden&gt; thing.create_child :name =&gt; &quot;Child&quot;&#x000A;=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1,...&gt;&#x000A;zengarden&gt; thing.child&#x000A;=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1...&gt;&#x000A;zengarden&gt; thing.child.destroy&#x000A;=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1...&gt;&#x000A;zengarden&gt; thing.child&#x000A;=&gt; #&lt;Child id: 4, name: &quot;Child&quot;, thing_id: 1...&gt;</code></pre>&#x000A;&#x000A;<p>Arg. I just destroyed it! I don&#8217;t want it hanging around in my cache. If I really wanted to save it, I should have saved it before or during the destroy call. I can of course invalidate my cache by calling</p>&#x000A;&#x000A;<pre><code>thing.child(true)</code></pre>&#x000A;&#x000A;<p>which correctly returns nil. But if I don&#8217;t know to do that immediately after the destroy, I get errors like</p>&#x000A;&#x000A;<blockquote>&#x000A;<p>TypeError: can&#8217;t modify frozen hash</p>&#x000A;</blockquote>&#x000A;&#x000A;<p>because code used later naïvely calls</p>&#x000A;&#x000A;<pre><code>if thing.child&#x000A;  thing.child.attributes = new_attributes&#x000A;end</code></pre>&#x000A;&#x000A;<p>expecting that if a child exists, it should be updated.</p>&#x000A;&#x000A;<p>For the sake of argument, let&#8217;s say that maybe the behavior isn&#8217;t so bad, maybe this is what people expect or could use. In that case, what a terrible error message. I&#8217;m not familiar enough with the Associations internals to suggest where a better one could be injected, but something along the lines of</p>&#x000A;&#x000A;<blockquote>&#x000A;<p>Can&#8217;t modify a destroyed record</p>&#x000A;</blockquote>&#x000A;&#x000A;<p>would be miles better.</p>&#x000A;<div class='footnotes'><hr /><ol><li id='fn:1'>&#x000A;<p>Rails 3 - <a href='http://railsapi.com/doc/rails-v3.0.0/classes/ActiveRecord/Persistence.html#M001019'>http://railsapi.com/doc/rails-v3.0.0/classes/ActiveRecord/Persistence.html#M001019</a></p>&#x000A;<a href='#fnref:1' rev='footnote'>&#8617;</a></li><li id='fn:2'>&#x000A;<p>Rails 2.3.8 - <a href='http://railsapi.com/doc/rails-v2.3.8/classes/ActiveRecord/Base.html#M001111'>http://railsapi.com/doc/rails-v2.3.8/classes/ActiveRecord/Base.html#M001111</a></p>&#x000A;<a href='#fnref:2' rev='footnote'>&#8617;</a></li></ol></div>
          </div>
          <footer>
            <div class='published'>
              Published at
              <time datetime='2010-10-25T18:31Z' itemprop='datePublished' pubdate>October 25, 2010, 1:31 pm</time>
            </div>
          </footer>
        </article>
      </div>
    </div>
    <footer>
      <div class='container'>
        <section class='author'>
          <h2>
            Written by
            <a href='http://adamstegman.com/' rel='author'>Adam Stegman</a>
          </h2>
          <ul class='contact'>
            <li>
              <a href='http://twitter.com/adamstegman'>Follow me on Twitter</a>
            </li>
            <li>
              <a href='http://github.com/adamstegman'>Follow me on Github</a>
            </li>
            <li>
              <a href='http://profiles.google.com/adam.stegman'>Google Profile</a>
            </li>
            <li>
              <a href='mailto:me@adamstegman.com'>Email me</a>
            </li>
          </ul>
        </section>
      </div>
    </footer>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-24951237-1']);
      _gaq.push(['_setDomainName', '.adamstegman.com']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
