{"data":{"markdownRemark":{"html":"<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABy2LmaoAn/8QAGRAAAwEBAQAAAAAAAAAAAAAAAQIRABAh/9oACAEBAAEFAl9LLNcphvP/xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BgX//xAAVEQEBAAAAAAAAAAAAAAAAAAAQIf/aAAgBAgEBPwGn/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRABAQEBAQEAAAAAAAAAAAAAAQARITGB/9oACAEBAAE/IQ4Bv2QmhcSElp9nr7f/2gAMAwEAAgADAAAAEC//AP/EABcRAAMBAAAAAAAAAAAAAAAAAAEQESH/2gAIAQMBAT8QENX/xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8Qbop//8QAGhABAQEBAQEBAAAAAAAAAAAAAREAIUFRYf/aAAgBAQABPxAFVsnC5sBT7c2iN/OTMHEbkHS9981qqX67/9k='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Chain link fence in focus with blurry city lights behind\"\n        title=\"\"\n        src=\"/static/0e416124fe3a62ed68c2b446728e78a7/fa9d5/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg\"\n        srcset=\"/static/0e416124fe3a62ed68c2b446728e78a7/30a96/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 240w,\n/static/0e416124fe3a62ed68c2b446728e78a7/288d4/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 480w,\n/static/0e416124fe3a62ed68c2b446728e78a7/fa9d5/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 960w,\n/static/0e416124fe3a62ed68c2b446728e78a7/78106/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 1440w,\n/static/0e416124fe3a62ed68c2b446728e78a7/fb391/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 1920w,\n/static/0e416124fe3a62ed68c2b446728e78a7/11ea9/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \nPhoto by <a href=\"https://unsplash.com/photos/Zw2-HhnCV2U\">Yannik Wenk</a> on <a href=\"https://unsplash.com/\">Unsplash</a></p>\n<p>This article is part of a series on migrating to <a href=\"https://aws.amazon.com/elasticbeanstalk/\">Elastic Beanstalk</a> from a <a href=\"http://12factor.net/\">12-factor</a> application platform.\nIt also introduces <a href=\"https://github.com/onemedical/elastic_beans\">our <code>elastic_beans</code> CLI</a>, a replacement for the built-in AWS eb CLI.\nFor an explanation of why we chose Elastic Beanstalk, and why we chose to write a replacement CLI, see <a href=\"./migrating-to-elastic-beanstalk\">the first article in the series</a>.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li>End-to-End Encryption and Private Networking</li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>\n<p>Security is our priority, and ensuring we protect our patients' data was a major focus for this migration.\nWe must protect network traffic, data stored on our servers, and data stored on our clients.\nClient access to data is outside the scope of this series, but in this document I will discuss network architecture and end-to-end encryption on Elastic Beanstalk.</p>\n<h2>Network architecture</h2>\n<p>Running on a public platform meant we couldn't take much advantage of firewalls.\nInstead we had to rely only on authentication to protect access to our data.\nMigrating to Elastic Beanstalk afforded us the opportunity to rethink our application's network architecture.</p>\n<p>Using a <a href=\"https://aws.amazon.com/vpc/\">Virtual Private Cloud (VPC)</a>, we can segregate our instances by their traffic patterns.\nWe create three subnets in each availability zone we want to use: one for application instances, one for load balancers, and one for <a href=\"https://en.wikipedia.org/wiki/Bastion_host\">a bastion server</a>.\nEach subnet has a route table and a security group that is specific to its function.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 936px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 107.6923076923077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAACWklEQVQ4y6VUTU8bMRDlV/avVO2de4899NY/QIWEaHvqrYKiUhXUZoEsCST7wa7t+Gv87U42QQJpOUR9slaWPG/med5493LOXnaON3l37AWrm6/7i8PXfPIlPkMY1hYppREyr4rpp7ez4/3pwRsQfYjJOesQFr/WD7DrvRshG71qL44YaZVSPgSMwjp4oJpCtYWPGVMYa40xI2StJHT32dgExnNuV9xyHjXIh8aSLlgfjQNCJCEZTFQ6A+BpGgogWRml75b1sm4cFncueJ9TMlobsP7+Upe/OONC8BDwxK+wgBB5uMVAlrL6/KGbTQCsBq0BnEcRXBnffT/oTo/EOkTGoWcXfy5J0+QQBrIUTgH7ccwmZ6uqhdu5u1uERa3KuacM0zmu9HUpb27TsklSWlTHefKbyhqs1GAsagJCJWWKsgBgOMdyD9VSUgJc6NUKpSZrs/cJ77VpGKvL7vb3sm4Xy0Vb1QbtiRHbjh1G8Rt/ffDOb61Kw9qSRV/JembAR601pWjpNiimjcPDqCQX4phVYBzt1dWZkQLQp0fyY4roU9Z1Kb59RCOwJqWUkH5LBhdVcVK9e/XQt4IL95ychw73s0l5+N6tVcTp9LooJo9k7E1Vs9OTNJ1bQvGqacDTBNpYpsxm8p7LRnR99bcgVze6J6MzjDTvx2ZbcM4IWiS41qzvGaVt2xJC7BOguvGHEZzzxlBGMb1Vev0UQ9i8wacYf88Yq4U8P/+ppPQ48S/EvUD2AZSSBsK6sso7kVEkis5MJMIANzv9htbTtxKuvPPzRZBqN3L+D/wDlbf7BMMcji4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Networking diagram representing this article\"\n        title=\"\"\n        src=\"/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png\"\n        srcset=\"/static/97334c0fb410a8401865592c76d19a92/31d41/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 240w,\n/static/97334c0fb410a8401865592c76d19a92/2741e/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 480w,\n/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 936w\"\n        sizes=\"(max-width: 936px) 100vw, 936px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>The application route table uses a <a href=\"http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html\">NAT gateway</a> to allow egress traffic to reach the outside internet.\nThe application security group allows only HTTP and HTTPS ingress traffic (ports 80 and 443), and only from the load balancer security group.\nIn turn the load balancer security group allows only HTTP and HTTPS ingress traffic, but from anywhere.\nThe route table for the load balancer subnet uses an internet gateway to route traffic, because the subnet is only for publicly-accessible nodes.</p>\n<p>The bastion subnet shares a route table with the load balancer subnet because it is also intended for public access.\nHowever its security group only allows SSH ingress traffic (port 22).\nWe have one more security group to allow SSH ingress traffic from the bastion server to the application instances.</p>\n<p>These resources must all exist separately in each of development, staging, and production environments.\nUsing [CloudFormation][] we can write a template encoding these resources and relationships and deploy it in each environment.\nThe <code>elastic_beans</code> wiki has <a href=\"https://github.com/onemedical/elastic_beans/wiki/Getting-started#create-a-networking-stack\">an example</a> that includes everything necessary.</p>\n<h3>Integration with Elastic Beanstalk</h3>\n<p><a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/vpc.html#d0e54425\">Elastic Beanstalk supports a VPC public/private network architecture</a> like this one, but requires some configuration before creating instances.\n<code>elastic_beans</code> will configure this automatically using the <code>configure</code> command, given the appropriate CloudFormation stack.\nUsing CloudFormation is a best practice that also minimizes the number of arguments we must pass to <code>elastic_beans</code>.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development</code></pre>\n      </div>\n<p>This command assumes we have already <a href=\"https://github.com/onemedical/elastic_beans/wiki/Getting-started#create-a-networking-stack\">created our Elastic Beanstalk application</a> and named it <code>myapp</code>.\n<code>elastic_beans</code> fetches the appropriate details from the Outputs configured in the template and sets them in configuration templates, also known as saved configurations.\nAny applications we create using <code>elastic_beans</code> will use the correct configuration template and be created in our desired network layout.</p>\n<p>We can re-use this networking stack for more applications if we are comfortable with them sharing a network.\nThis is useful for development environments that will not contain sensitive data.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a another-app -n networking-development</code></pre>\n      </div>\n<h3>Bastion server</h3>\n<p>The <a href=\"https://en.wikipedia.org/wiki/Bastion_host\">bastion server</a> serves as an SSH proxy if we need shell access to our application instances.\nDuring the <code>configure</code> command, <code>elastic_beans</code> found our security group allowing access from the bastion server to our application instances and added it to the Elastic Beanstalk configuration.\nNow, if we have the private key and public IP address for the bastion server and the private IP address of the application instance we want to access, we can proxy through the bastion using <code>ssh</code>.\n<code>elastic_beans</code> also automates this for us:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans ssh webserver -a myapp \\\n  -i $KEYPAIR \\\n  --bastion-host $BASTION_IP --bastion-username $USER \\\n  --bastion-identity-file $PRIVATE_KEY</code></pre>\n      </div>\n<p>That said, shell access is rarely needed.\nDebugging is more effective using metrics and log aggregation and searching and monitoring in those places.\nInstead of running commands in an SSH session, commands are run using <code>beans exec</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans exec rake db:migrate -a myapp</code></pre>\n      </div>\n<p>Due to how powerful a local user can be, adequate protection of the bastion server is essential.\nBeyond attack and vulnerability mitigation, normal access must be controlled.\nAuditing access, protecting it behind multi-factor authentication, and good policy and access control are examples of ways to do this.</p>\n<h2>End-to-end encryption</h2>\n<p>Once our network is appropriately constructed, we can focus on protecting data in transit and at rest on our servers.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 936px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 107.6923076923077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAACWklEQVQ4y6VUTU8bMRDlV/avVO2de4899NY/QIWEaHvqrYKiUhXUZoEsCST7wa7t+Gv87U42QQJpOUR9slaWPG/med5493LOXnaON3l37AWrm6/7i8PXfPIlPkMY1hYppREyr4rpp7ez4/3pwRsQfYjJOesQFr/WD7DrvRshG71qL44YaZVSPgSMwjp4oJpCtYWPGVMYa40xI2StJHT32dgExnNuV9xyHjXIh8aSLlgfjQNCJCEZTFQ6A+BpGgogWRml75b1sm4cFncueJ9TMlobsP7+Upe/OONC8BDwxK+wgBB5uMVAlrL6/KGbTQCsBq0BnEcRXBnffT/oTo/EOkTGoWcXfy5J0+QQBrIUTgH7ccwmZ6uqhdu5u1uERa3KuacM0zmu9HUpb27TsklSWlTHefKbyhqs1GAsagJCJWWKsgBgOMdyD9VSUgJc6NUKpSZrs/cJ77VpGKvL7vb3sm4Xy0Vb1QbtiRHbjh1G8Rt/ffDOb61Kw9qSRV/JembAR601pWjpNiimjcPDqCQX4phVYBzt1dWZkQLQp0fyY4roU9Z1Kb59RCOwJqWUkH5LBhdVcVK9e/XQt4IL95ychw73s0l5+N6tVcTp9LooJo9k7E1Vs9OTNJ1bQvGqacDTBNpYpsxm8p7LRnR99bcgVze6J6MzjDTvx2ZbcM4IWiS41qzvGaVt2xJC7BOguvGHEZzzxlBGMb1Vev0UQ9i8wacYf88Yq4U8P/+ppPQ48S/EvUD2AZSSBsK6sso7kVEkis5MJMIANzv9htbTtxKuvPPzRZBqN3L+D/wDlbf7BMMcji4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Networking diagram representing this article\"\n        title=\"\"\n        src=\"/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png\"\n        srcset=\"/static/97334c0fb410a8401865592c76d19a92/31d41/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 240w,\n/static/97334c0fb410a8401865592c76d19a92/2741e/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 480w,\n/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 936w\"\n        sizes=\"(max-width: 936px) 100vw, 936px\"\n      />\n    </span>\n  </span>\n  </p>\n<h3>Data in transit</h3>\n<p>There are a couple different places we must encrypt data in transit.</p>\n<ul>\n<li>Clients send data to the ELB that Elastic Beanstalk creates</li>\n<li>The ELB sends data to application instances</li>\n</ul>\n<p>I will discuss both of these. There are a lot of other ways data is transmitted that I will not discuss, because the solutions are less reusable:</p>\n<ul>\n<li>SSH clients can access data by virtue of being on a host</li>\n<li>Data is sent to various services, e.g. stored in RDBMS or key-value store, indexed by a search service, integrated with third parties</li>\n<li>Logs are sent to a log aggregation service</li>\n</ul>\n<p>Protecting each of these data transmissions is outside the scope of this article.\nThe solutions are specific to the service and methods in use.\nThe basic guiding principle is: all network access should be encrypted and trusted.</p>\n<h3>Clients send data to the ELB</h3>\n<p>To protect data in transit from a client to our load balancer, we use HTTPS.\nElastic Load Balancers are configured with a listener for HTTPS traffic coupled with an IAM server certificate.\nElastic Beanstalk can be configured to <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https.html\">set up its load balancers for HTTPS traffic</a>.\n<code>elastic_beans</code> automates this configuration for us! Given that we have our own domain and a valid certificate for that domain, we can upload it along with its private key and the certificate chain for our certificate authority (CA).\nOnce uploaded, we have an ARN representing that certificate within IAM.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>$ aws iam upload-server-certificate ...\n{\n    \"ServerCertificateMetadata\": {\n        \"ServerCertificateId\": \"...\",\n        \"ServerCertificateName\": \"...\",\n        \"Expiration\": \"...\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::123456789012:server-certificate/elastic-beanstalk-x509\",\n        \"UploadDate\": \"...\"\n    }\n}</code></pre>\n      </div>\n<p>We pass that ARN to <code>elastic_beans</code> so it can configure all of the Elastic Beanstalk option settings automatically for us. 🎉</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development \\\n  -s arn:aws:iam::123456789012:server-certificate/elastic-beanstalk-x509</code></pre>\n      </div>\n<h3>ELB sends data to application instances</h3>\n<p>With a server certificate configured on our ELB, it will decrypt traffic at that point.\nThis means data is passed around within our VPC unencrypted, which is unacceptable.\nUnencrypted data over a network connection, even within a VPC, could be leaked, intentionally or unintentionally.\nWe can encrypt data that is passed from the ELB to our application instances:</p>\n<ul>\n<li><a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-ruby.html#Puma\">configure nginx to listen for HTTPS traffic with an SSL certificate and private key</a></li>\n<li><a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-endtoend.html\">configure a backend policy on the ELB with the public key for that certificate</a></li>\n</ul>\n<p>Since this certificate is only used internally, we can self-sign a certificate, or use a valid certificate.\nSecurity groups were defined in our CloudFormation stack following the guidelines from the \"Network Architecture\" section discussed earlier.\n<code>elastic_beans</code> will use those and set up our ELB listeners correctly.\nA future version of <code>elastic_beans</code> could generate an internal certificate and set up an HTTPS server on nginx automatically; for now, our application must configure nginx and give <code>elastic_beans</code> the public key for the load balancer.</p>\n<p>We set up an <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\"><code>.ebextensions</code> configuration</a> for nginx following the directions from the first bullet point above.\nIt creates files with our certificate and private key, and adds nginx configuration for an HTTPS server using the certificate and private key.\nWe can find our public key using <code>openssl</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>$ openssl x509 -in ./cert.crt -noout -pubkey\n-----BEGIN PUBLIC KEY-----\nSOMEPUBLICKEYCONTENTS\n-----END PUBLIC KEY-----</code></pre>\n      </div>\n<p>Then we can pass the contents of the public key to <code>beans configure</code> to set up the ELB backend policy:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development \\\n  -p 'SOMEPUBLICKEYCONTENTS'</code></pre>\n      </div>\n<h3>Data at rest</h3>\n<p>The data from a request generally does not reach the disk, but it is logged and our log files are stored on disk.\nWe can <a href=\"https://aws.amazon.com/blogs/aws/new-encrypted-ebs-boot-volumes/\">encrypt the AMIs</a> provided by Elastic Beanstalk and configure our application to use the encrypted versions.\nFirst we must create our own copy of the image, then we can encrypt it using a key from Amazon KMS, and clean up the unencrypted copy.\nWe've automated this in our continuous integration system so that every new Elastic Beanstalk image is copied and encrypted.</p>\n<p>Once we have an encrypted image, we use <code>elastic_beans</code> to configure our servers to use it instead of the default.\nExisting instances will be re-created, and any new environments or instances will be created using this image.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development \\\n  -i $AMI_ID</code></pre>\n      </div>\n<h2>Configuring with <code>elastic_beans</code></h2>\n<p>All together, the options discussed in this article are used by <code>beans configure</code> to set up an Elastic Beanstalk application for end-to-end encryption.\nThis saves us a lot of manual work on every application we set up!</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a $APP_NAME \\\n  -n $NETWORKING_CLOUDFORMATION_STACK \\\n  -i $AMI_ID \\\n  -s $SERVER_CERTIFICATE_ARN \\\n  -p $PUBLIC_KEY</code></pre>\n      </div>\n<h2>Elastic Beanstalk Migration</h2>\n<p>Overall the migration process has been fairly straightforward.\n<code>elastic_beans</code> has helped the Core Infrastructure group spare the rest of the team from most of these difficulties.\nWe are excited to be using a more secure, compliant, and scalable hosting platform!</p>\n<p>In future articles in this series, I will cover some of the issues we have overcome and how <code>elastic_beans</code> helps us solve them.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li>End-to-End Encryption and Private Networking</li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>","fields":{"post":{"title":"Elastic Beanstalk: End-to-End Encryption and Private Networking","link":null,"timestamp":"2017-02-08T18:20Z","date":"February 8, 2017 6:20pm UTC"}}}},"pageContext":{"slug":"/elastic-beanstalk-end-to-end-encryption-and-private-networking"}}