{"data":{"markdownRemark":{"html":"<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHXJ4wopX//xAAaEAACAgMAAAAAAAAAAAAAAAAAARITAgMh/9oACAEBAAEFAoDxIlo9nbT/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwGI/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Bqv/EABYQAQEBAAAAAAAAAAAAAAAAAAAxEP/aAAgBAQAGPwLYiP/EAB0QAAICAQUAAAAAAAAAAAAAAAABEVEhMWFxkbH/2gAIAQEAAT8haUJoeeg9vsjl7OE//9oADAMBAAIAAwAAABDrz//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/ELW//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QlL//xAAYEAEBAQEBAAAAAAAAAAAAAAABABEhsf/aAAgBAQABPxABOjiA4jjlNEDczItX0b//2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Clock on a wall\"\n        title=\"\"\n        src=\"/static/e0fc4ed11c707ed207a03e9e98b395d9/fa9d5/elastic-beanstalk-one-off-and-periodic-tasks.jpeg\"\n        srcset=\"/static/e0fc4ed11c707ed207a03e9e98b395d9/30a96/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 240w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/288d4/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 480w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/fa9d5/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 960w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/78106/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 1440w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/fb391/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 1920w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/11ea9/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \nPhoto by <a href=\"https://unsplash.com/photos/K9zVc7B_XPI\">Eder Pozo Pérez</a> on <a href=\"https://unsplash.com/\">Unsplash</a></p>\n<p>This article is part of a series on migrating to <a href=\"https://aws.amazon.com/elasticbeanstalk/\">Elastic Beanstalk</a> from a <a href=\"http://12factor.net/\">12-factor</a> application platform.\nIt also introduces <a href=\"https://github.com/onemedical/elastic_beans\">our <code>elastic_beans</code> CLI</a>, a replacement for the built-in AWS eb CLI.\nFor an explanation of why we chose Elastic Beanstalk, and why we chose to write a replacement CLI, see <a href=\"./migrating-to-elastic-beanstalk\">the first article in the series</a>.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li>Periodic Tasks</li>\n</ol>\n<p>One of the features of Elastic Beanstalk is <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html#worker-periodictasks\">built-in support for periodic tasks</a>.\nThere are several limitations with this support that make it insufficient for our needs:</p>\n<ul>\n<li>Each periodic task needs a custom HTTP endpoint</li>\n<li><code>cron.yaml</code> is loaded in every worker environment, which means each periodic task would be invoked concurrently in each worker environment</li>\n<li>Worker environments have configurable timeouts that max out at 30 minutes</li>\n</ul>\n<p>To overcome these, we have re-implemented periodic task execution in <code>elastic_beans</code>.\nThe setup is based on the built-in periodic task configuration, but tasks are executed independently in a special <code>exec</code> environment.</p>\n<h2>Limitations</h2>\n<p>Periodic tasks are executed like a background job in a worker environment, which <a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">I previously described some limitations of</a>:</p>\n<blockquote>\n<p>Jobs are enqueued for background processing on <a href=\"https://aws.amazon.com/sqs/\">Amazon SQS</a> and the workers execute jobs by sending an HTTP POST to <code>http://localhost/</code>.</p>\n</blockquote>\n<p>The <a href=\"https://github.com/tawan/active-elastic-job\">active-elastic-job gem</a> handles execution of worker requests.\nPeriodic tasks, however, have a custom endpoint defined for each task that should perform the desired task.\nOur periodic tasks were already written as rake tasks, so this would entail quite a bit of refactoring, and be difficult to maintain in the future.\nCreating endpoints to perform these tasks would lead to surprising and confusing features in a Rails codebase.\nThese tasks do not naturally fit into a web request workflow and would require security, operational, and configuration changes that are not typical of our controllers.</p>\n<hr>\n<h3>What about active-elastic-job?</h3>\n<p>The newest version of active-elastic-job handles periodic task requests from Elastic Beanstalk, which would solve the custom endpoint problem above.\nPeriodic tasks are written as background jobs and handled in the same way.\nUnfortunately, other limitations still apply, so it's helpful but insufficient.</p>\n<hr>\n<p>Another <a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">limitation I previously described</a>:</p>\n<blockquote>\n<p>The value of <code>VisibilityTimeout</code> should … be high enough for any job to complete.</p>\n</blockquote>\n<p>Some of our periodic tasks can take quite a while to process.\nElastic Beanstalk and SQS place a limit of 30 minutes on processing time via the <code>VisibilityTimeout</code>.\nWe could potentially refactor our tasks to help with this by enqueuing sub-tasks, but this is error-prone and time-consuming.</p>\n<p>Finally, Elastic Beanstalk uses the aforementioned <code>cron.yaml</code> file to schedule tasks.\nSince we use the same codebase across all environments (webserver and workers), the <code>cron.yaml</code> would be loaded and processed in each environment.\nOur tasks should be resilient to multiple invocations by remaining idempotent, so theoretically this would not be an issue.\nBut when they are running concurrently, new problems arise that are hard to predict.</p>\n<hr>\n<h3>What about just using cron?</h3>\n<p>The limitations of the built-in periodic task support are because Elastic Beanstalk is in control.\nIf we ignore <code>cron.yaml</code>, we could re-implement periodic tasks using normal cron jobs.\nHowever, similar limitations apply:</p>\n<ul>\n<li>predictable resource allocation (CPU, memory, etc.) depends on separating background jobs from periodic tasks</li>\n<li>parallelization across multiple instances is impossible</li>\n</ul>\n<p>Additionally, we try to use as much built-in functionality in Elastic Beanstalk as we can.\nWriting things ourselves is possible, but is yet another thing to maintain and monitor indefinitely.</p>\n<hr>\n<h2>How <code>elastic_beans</code> executes one-off tasks</h2>\n<p>One of the features of <code>elastic_beans</code> is an \"exec\" environment intended for one-off tasks run by an engineer or operator.\nThe exec environment is kept separate to avoid one-off tasks interfering with regular operation of web requests and background job execution.\nIt's also a convenient place to run interactive tasks so that engineers and operators don't SSH into web servers or workers while they are doing other work.</p>\n<p>Each <code>elastic_beans</code> application is configured with an \"exec\" queue in SQS.\nA custom listener is deployed in the \"exec\" environment to poll that queue and run commands it finds.\nThe <code>elastic_beans</code> CLI provides a <code>beans exec</code> command that enqueues shell commands for execution in this environment.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans exec rake db:migrate -a myapp</code></pre>\n      </div>\n<p>Logs are written to <a href=\"https://github.com/onemedical/elastic_beans/wiki/Logging\">a well-known location</a> and can be collected to a log aggregation service for later review.</p>\n<h2>How elastic_beans executes periodic tasks</h2>\n<p>We realized that periodic tasks are merely a specialized form of one-off task.\nThey are automatically invoked instead of manually, but otherwise they are the same.\nThe exec environment already:</p>\n<ul>\n<li>runs commands from a shell instead of a web request</li>\n<li>allows commands to run arbitrarily long, one at a time</li>\n</ul>\n<p>The missing piece was hooking our <code>cron.yaml</code> up to the exec environment.\nNow, <code>elastic_beans</code> <a href=\"https://github.com/onemedical/elastic_beans#periodic-tasks\">provides a middleware</a> to intercept periodic task requests to an <code>/exec</code> endpoint and enqueue them as if they were run with <code>beans exec</code>.\nLike active-elastic-job, it first checks to ensure the message is from the SQS daemon on localhost.\nOur application adds the middleware to the stack in an initializer:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>Rails.configuration.middleware.insert_before(\n  ActionDispatch::SSL,\n  ElasticBeans::Rack::Exec,\n  application: ElasticBeans::Application.new(\n    name: \"myapp\",\n    cloudformation: Aws::CloudFormation::Client.new,\n    elastic_beanstalk: Aws::ElasticBeanstalk::Client.new,\n    s3: Aws::S3::Client.new,\n    sqs: Aws::SQS::Client.new,\n  ),\n  logger: Rails.logger,\n)</code></pre>\n      </div>\n<p>The final limitation was having multiple environments load <code>cron.yaml</code>.\nSince <code>elastic_beans</code> performs deployment, it can inject configuration <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\">via <code>.ebextensions</code></a>.\nNow, it removes the <code>cron.yaml</code> file in every environment except one called \"scheduler,\" whose responsibility is only to enqueue these tasks.</p>\n<h2>Elastic Beanstalk Migration</h2>\n<p>Overall the migration process has been fairly straightforward.\n<code>elastic_beans</code> has helped the Core Infrastructure group spare the rest of the team from most of these difficulties.\nWe are excited to be using a more secure, compliant, and scalable hosting platform!</p>\n<p>In future articles in this series, I will cover some of the issues we have overcome and how <code>elastic_beans</code> helps us solve them.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li>Periodic Tasks</li>\n</ol>\n<p>Thank you for following along with our journey!\nI hope you'll check out <a href=\"https://github.com/onemedical/elastic_beans\"><code>elastic_beans</code></a> if you also run a Rails app on Elastic Beanstalk, or want to.\nAnd if this sounded like a fun project, there's much more on the roadmap for our Core Infrastructure team, <a href=\"https://www.onemedical.com/jobs/product/\">drop us a line</a>!</p>","fields":{"post":{"title":"Elastic Beanstalk: One-off and Periodic Tasks","link":null,"timestamp":"2017-02-10T18:20Z","date":"February 10, 2017 6:20pm UTC"}}}},"pageContext":{"slug":"/elastic-beanstalk-one-off-and-periodic-tasks"}}