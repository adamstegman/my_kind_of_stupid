{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>On large software projects, communication is key. There are so many ways we can try to facilitate regular communication between engineering teams, but I believe one of the best is regular rotation of engineers between the teams. Working on a new team fosters knowledge sharing, shared ownership and responsibility, better technical decisions, and builds communication and technical skills for each of the engineers.</p>\n<p>I define knowledge sharing between software teams as understanding what other teams do: their goals, process, products, and code. Understanding each of these things enables effective communication and planning on your own team. When someone new is rotated onto the team, they have the opportunity to see these processes first-hand, perform them, and improve them with an outside perspective. Performing something yourself is a great way to actually understand it. When that new person rotates off the team, their understanding will also become out of date, but now that can be resolved with a conversation with someone now on that team. Now they know who to talk to, and their shared base of understanding enables them to have that conversation more effectively than starting from scratch.</p>\n<p>A shared base of understanding also contributes to shared ownership and responsibility for the entire project. When things go wrong, we don’t always get the opportunity to learn what went wrong, how it was resolved, and how to prevent it in the future. Missing these leave us with a lack of confidence in our ability to troubleshoot and resolve future issues, and result in a culture of avoiding issues that we don’t understand. This culture spreads very quickly. Regular rotation between teams provides a lot more opportunity to observe these issues and learn from them. It builds a network of people to talk to, and that shared base of understanding that you can use to figure out an issue even without immediately recognizing it.</p>\n<p>Regular rotation between teams builds a network of people to talk to organically. Knowing who to talk to about a given topic is invaluable, but difficult to build from scratch. We have the opportunity to find this network every day that we work closely with several people. Increasing that number by rotating between teams helps that network grow so you can be more confident in finding the answer to your problem. Working with new people regularly helps you learn to communicate with different people who have difference communication styles. Likewise, working with new codebases helps you learn different patterns and how to fit your own style into a new team.</p>\n<p>These are all the reasons I think regular team rotation is very important. It’s difficult to implement for several reasons, like reluctance from individuals, aligning individuals with managers, and balancing staffing needs with department goals. So I don’t like making hard rules about rotation, but instead keeping it as a goal and metric to be tracked and discussed with each individual and team regularly.</p>\n<p>I’ve tried hard to keep pair programming out of this discussion so far, but bear with me now. I truly believe team rotation is essential to a healthy team, while pair programming is a little more optional. But pairing will multiply these results and make them much more visible and permanent. Pairing often involves rotation within a team that achieves these same results, so rotation between teams is a natural extension.</p>","fields":{"slug":"/regular-team-rotation","post":{"title":"Regular Team Rotation","link":null,"timestamp":"2017-07-05T17:00Z","date":"July 5, 2017 5:00pm UTC"}}}},{"node":{"html":"<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHXJ4wopX//xAAaEAACAgMAAAAAAAAAAAAAAAAAARITAgMh/9oACAEBAAEFAoDxIlo9nbT/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwGI/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Bqv/EABYQAQEBAAAAAAAAAAAAAAAAAAAxEP/aAAgBAQAGPwLYiP/EAB0QAAICAQUAAAAAAAAAAAAAAAABEVEhMWFxkbH/2gAIAQEAAT8haUJoeeg9vsjl7OE//9oADAMBAAIAAwAAABDrz//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/ELW//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QlL//xAAYEAEBAQEBAAAAAAAAAAAAAAABABEhsf/aAAgBAQABPxABOjiA4jjlNEDczItX0b//2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Clock on a wall\"\n        title=\"\"\n        src=\"/static/e0fc4ed11c707ed207a03e9e98b395d9/fa9d5/elastic-beanstalk-one-off-and-periodic-tasks.jpeg\"\n        srcset=\"/static/e0fc4ed11c707ed207a03e9e98b395d9/30a96/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 240w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/288d4/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 480w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/fa9d5/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 960w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/78106/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 1440w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/fb391/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 1920w,\n/static/e0fc4ed11c707ed207a03e9e98b395d9/11ea9/elastic-beanstalk-one-off-and-periodic-tasks.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \nPhoto by <a href=\"https://unsplash.com/photos/K9zVc7B_XPI\">Eder Pozo Pérez</a> on <a href=\"https://unsplash.com/\">Unsplash</a></p>\n<p>This article is part of a series on migrating to <a href=\"https://aws.amazon.com/elasticbeanstalk/\">Elastic Beanstalk</a> from a <a href=\"http://12factor.net/\">12-factor</a> application platform.\nIt also introduces <a href=\"https://github.com/onemedical/elastic_beans\">our <code>elastic_beans</code> CLI</a>, a replacement for the built-in AWS eb CLI.\nFor an explanation of why we chose Elastic Beanstalk, and why we chose to write a replacement CLI, see <a href=\"./migrating-to-elastic-beanstalk\">the first article in the series</a>.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li>Periodic Tasks</li>\n</ol>\n<p>One of the features of Elastic Beanstalk is <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html#worker-periodictasks\">built-in support for periodic tasks</a>.\nThere are several limitations with this support that make it insufficient for our needs:</p>\n<ul>\n<li>Each periodic task needs a custom HTTP endpoint</li>\n<li><code>cron.yaml</code> is loaded in every worker environment, which means each periodic task would be invoked concurrently in each worker environment</li>\n<li>Worker environments have configurable timeouts that max out at 30 minutes</li>\n</ul>\n<p>To overcome these, we have re-implemented periodic task execution in <code>elastic_beans</code>.\nThe setup is based on the built-in periodic task configuration, but tasks are executed independently in a special <code>exec</code> environment.</p>\n<h2>Limitations</h2>\n<p>Periodic tasks are executed like a background job in a worker environment, which <a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">I previously described some limitations of</a>:</p>\n<blockquote>\n<p>Jobs are enqueued for background processing on <a href=\"https://aws.amazon.com/sqs/\">Amazon SQS</a> and the workers execute jobs by sending an HTTP POST to <code>http://localhost/</code>.</p>\n</blockquote>\n<p>The <a href=\"https://github.com/tawan/active-elastic-job\">active-elastic-job gem</a> handles execution of worker requests.\nPeriodic tasks, however, have a custom endpoint defined for each task that should perform the desired task.\nOur periodic tasks were already written as rake tasks, so this would entail quite a bit of refactoring, and be difficult to maintain in the future.\nCreating endpoints to perform these tasks would lead to surprising and confusing features in a Rails codebase.\nThese tasks do not naturally fit into a web request workflow and would require security, operational, and configuration changes that are not typical of our controllers.</p>\n<hr>\n<h3>What about active-elastic-job?</h3>\n<p>The newest version of active-elastic-job handles periodic task requests from Elastic Beanstalk, which would solve the custom endpoint problem above.\nPeriodic tasks are written as background jobs and handled in the same way.\nUnfortunately, other limitations still apply, so it's helpful but insufficient.</p>\n<hr>\n<p>Another <a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">limitation I previously described</a>:</p>\n<blockquote>\n<p>The value of <code>VisibilityTimeout</code> should … be high enough for any job to complete.</p>\n</blockquote>\n<p>Some of our periodic tasks can take quite a while to process.\nElastic Beanstalk and SQS place a limit of 30 minutes on processing time via the <code>VisibilityTimeout</code>.\nWe could potentially refactor our tasks to help with this by enqueuing sub-tasks, but this is error-prone and time-consuming.</p>\n<p>Finally, Elastic Beanstalk uses the aforementioned <code>cron.yaml</code> file to schedule tasks.\nSince we use the same codebase across all environments (webserver and workers), the <code>cron.yaml</code> would be loaded and processed in each environment.\nOur tasks should be resilient to multiple invocations by remaining idempotent, so theoretically this would not be an issue.\nBut when they are running concurrently, new problems arise that are hard to predict.</p>\n<hr>\n<h3>What about just using cron?</h3>\n<p>The limitations of the built-in periodic task support are because Elastic Beanstalk is in control.\nIf we ignore <code>cron.yaml</code>, we could re-implement periodic tasks using normal cron jobs.\nHowever, similar limitations apply:</p>\n<ul>\n<li>predictable resource allocation (CPU, memory, etc.) depends on separating background jobs from periodic tasks</li>\n<li>parallelization across multiple instances is impossible</li>\n</ul>\n<p>Additionally, we try to use as much built-in functionality in Elastic Beanstalk as we can.\nWriting things ourselves is possible, but is yet another thing to maintain and monitor indefinitely.</p>\n<hr>\n<h2>How <code>elastic_beans</code> executes one-off tasks</h2>\n<p>One of the features of <code>elastic_beans</code> is an \"exec\" environment intended for one-off tasks run by an engineer or operator.\nThe exec environment is kept separate to avoid one-off tasks interfering with regular operation of web requests and background job execution.\nIt's also a convenient place to run interactive tasks so that engineers and operators don't SSH into web servers or workers while they are doing other work.</p>\n<p>Each <code>elastic_beans</code> application is configured with an \"exec\" queue in SQS.\nA custom listener is deployed in the \"exec\" environment to poll that queue and run commands it finds.\nThe <code>elastic_beans</code> CLI provides a <code>beans exec</code> command that enqueues shell commands for execution in this environment.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans exec rake db:migrate -a myapp</code></pre>\n      </div>\n<p>Logs are written to <a href=\"https://github.com/onemedical/elastic_beans/wiki/Logging\">a well-known location</a> and can be collected to a log aggregation service for later review.</p>\n<h2>How elastic_beans executes periodic tasks</h2>\n<p>We realized that periodic tasks are merely a specialized form of one-off task.\nThey are automatically invoked instead of manually, but otherwise they are the same.\nThe exec environment already:</p>\n<ul>\n<li>runs commands from a shell instead of a web request</li>\n<li>allows commands to run arbitrarily long, one at a time</li>\n</ul>\n<p>The missing piece was hooking our <code>cron.yaml</code> up to the exec environment.\nNow, <code>elastic_beans</code> <a href=\"https://github.com/onemedical/elastic_beans#periodic-tasks\">provides a middleware</a> to intercept periodic task requests to an <code>/exec</code> endpoint and enqueue them as if they were run with <code>beans exec</code>.\nLike active-elastic-job, it first checks to ensure the message is from the SQS daemon on localhost.\nOur application adds the middleware to the stack in an initializer:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>Rails.configuration.middleware.insert_before(\n  ActionDispatch::SSL,\n  ElasticBeans::Rack::Exec,\n  application: ElasticBeans::Application.new(\n    name: \"myapp\",\n    cloudformation: Aws::CloudFormation::Client.new,\n    elastic_beanstalk: Aws::ElasticBeanstalk::Client.new,\n    s3: Aws::S3::Client.new,\n    sqs: Aws::SQS::Client.new,\n  ),\n  logger: Rails.logger,\n)</code></pre>\n      </div>\n<p>The final limitation was having multiple environments load <code>cron.yaml</code>.\nSince <code>elastic_beans</code> performs deployment, it can inject configuration <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\">via <code>.ebextensions</code></a>.\nNow, it removes the <code>cron.yaml</code> file in every environment except one called \"scheduler,\" whose responsibility is only to enqueue these tasks.</p>\n<h2>Elastic Beanstalk Migration</h2>\n<p>Overall the migration process has been fairly straightforward.\n<code>elastic_beans</code> has helped the Core Infrastructure group spare the rest of the team from most of these difficulties.\nWe are excited to be using a more secure, compliant, and scalable hosting platform!</p>\n<p>In future articles in this series, I will cover some of the issues we have overcome and how <code>elastic_beans</code> helps us solve them.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li>Periodic Tasks</li>\n</ol>\n<p>Thank you for following along with our journey!\nI hope you'll check out <a href=\"https://github.com/onemedical/elastic_beans\"><code>elastic_beans</code></a> if you also run a Rails app on Elastic Beanstalk, or want to.\nAnd if this sounded like a fun project, there's much more on the roadmap for our Core Infrastructure team, <a href=\"https://www.onemedical.com/jobs/product/\">drop us a line</a>!</p>","fields":{"slug":"/elastic-beanstalk-one-off-and-periodic-tasks","post":{"title":"Elastic Beanstalk: One-off and Periodic Tasks","link":null,"timestamp":"2017-02-10T18:20Z","date":"February 10, 2017 6:20pm UTC"}}}},{"node":{"html":"<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 67.85%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAAF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdgB3oaZL//EABoQAAICAwAAAAAAAAAAAAAAAAECERIDEBP/2gAIAQEAAQUCgRkZbKRWWZ+Y1//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAQACAwAAAAAAAAAAAAAAAAAhIgExYf/aAAgBAQAGPwLiJaWysh//xAAaEAACAwEBAAAAAAAAAAAAAAABEQAhMVFh/9oACAEBAAE/ISBcgBBfLyKgQryEE0pLkfdlMqgn/9oADAMBAAIAAwAAABA/L//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABYRAQEBAAAAAAAAAAAAAAAAAAAxEf/aAAgBAgEBPxCVr//EAB4QAAICAgIDAAAAAAAAAAAAAAERACExUUFxgbHh/9oACAEBAAE/EG+gDDS8wKLSyYbfP2ANUFfrLWGQE5U67gBAq0AKrUJKIAKCc//Z'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Queue of people in a plaza\"\n        title=\"\"\n        src=\"/static/825e5873fbcf9842685a2c5b3540cd28/fa9d5/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg\"\n        srcset=\"/static/825e5873fbcf9842685a2c5b3540cd28/30a96/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg 240w,\n/static/825e5873fbcf9842685a2c5b3540cd28/288d4/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg 480w,\n/static/825e5873fbcf9842685a2c5b3540cd28/fa9d5/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg 960w,\n/static/825e5873fbcf9842685a2c5b3540cd28/78106/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg 1440w,\n/static/825e5873fbcf9842685a2c5b3540cd28/fb391/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg 1920w,\n/static/825e5873fbcf9842685a2c5b3540cd28/11ea9/elastic-beanstalk-migrating-background-jobs-to-sqs.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \nPhoto by <a href=\"https://unsplash.com/photos/VY1EDHABTDE\">Paul Dufour</a> on <a href=\"https://unsplash.com/\">Unsplash</a></p>\n<p>This article is part of a series on migrating to <a href=\"https://aws.amazon.com/elasticbeanstalk/\">Elastic Beanstalk</a> from a <a href=\"http://12factor.net/\">12-factor</a> application platform.\nIt also introduces <a href=\"https://github.com/onemedical/elastic_beans\">our <code>elastic_beans</code> CLI</a>, a replacement for the built-in AWS eb CLI.\nFor an explanation of why we chose Elastic Beanstalk, and why we chose to write a replacement CLI, see <a href=\"./migrating-to-elastic-beanstalk\">the first article in the series</a>.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li>Migrating Background Jobs to SQS</li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>\n<p>One of the features of Elastic Beanstalk is <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html\">dedicated worker environments</a>.\nJobs are enqueued for background processing on <a href=\"https://aws.amazon.com/sqs/\">Amazon SQS</a> and the workers execute jobs by sending an HTTP POST to <code>http://localhost/</code>.\nThis is not what we're used to with background job processing in Rails, but luckily there is <a href=\"https://rubygems.org/gems/active_elastic_job\">an active<em>elastic</em>job gem</a> that handles all of this for us using the built-in ActiveJob framework.\nHowever, there was a lot of work to do before this worked for us.</p>\n<h2>Migration</h2>\n<p>When we decided to migrate to Elastic Beanstalk, we had used <a href=\"https://github.com/collectiveidea/delayed_job\">delayed_job</a> for a few years as our queuing system.\nIt worked well enough, but there were occasional issues with deadlock in MySQL and we'd been wanting to migrate to something better-suited to a job queue.\nMigrating to Elastic Beanstalk provided us the opportunity to migrate to the built-in dedicated worker environments.</p>\n<p>We could have kept running delayed_job ourselves, but we decided not to.\nOne of our goals was to rely on our chosen platform as much as possible.\nUsing built-in solutions performs better, requires less maintenance, and will be better-supported.</p>\n<h2>Challenges</h2>\n<p>We had implicitly learned the flaws of delayed_job and designed a system that could not be seamlessly migrated to a new queuing system.</p>\n<p>We encountered a number of issues before and during this migration.\nThe basic principles of background processing were not changed, but the devil is in the details.\nWe had to grapple with changes to our development and operations practices as well as supporting Elastic Beanstalk from our worker instances.\nThe challenges I'll cover here are:</p>\n<ul>\n<li>Refactoring to support active<em>elastic</em>job</li>\n<li>Handling multiple queues in SQS</li>\n<li>Tracking pending jobs</li>\n<li>Race conditions</li>\n<li>Retrying failed jobs</li>\n<li>Supporting the Elastic Beanstalk health check</li>\n</ul>\n<h3>Refactoring</h3>\n<p>Rails version 4.2 <a href=\"http://guides.rubyonrails.org/4_2_release_notes.html#active-job\">introduced a new framework called ActiveJob</a> to unify background job queuing systems.\nBefore ActiveJob, each queuing system had its own API, including delayed<em>job.\nAccordingly, all of our background jobs were written directly against the delayed</em>job API, even after we upgraded to Rails 4.2.\nWith the advent of Elastic Beanstalk, we knew a refactoring was in order.</p>\n<p>The ActiveJob API is pretty simple: inherit from <code>ActiveJob::Base</code> and define a method called <code>#perform</code>.\nMost of our jobs were what delayed_job calls \"<a href=\"https://github.com/collectiveidea/delayed_job/tree/v4.1.1#custom-jobs\">custom jobs</a>,\" which use the same method, so these jobs could be seamlessly refactored by inheriting from <code>ActiveJob::Base</code>.</p>\n<p>Our error-handling used <a href=\"https://github.com/collectiveidea/delayed_job/tree/v4.1.1#hooks\">the delayed_job error hook</a>, so we needed to update our jobs to use <a href=\"http://guides.rubyonrails.org/active_job_basics.html#exceptions\">ActiveJob error-handling</a> instead.</p>\n<p>Less conveniently, delayed<em>job has [two other ways of enqueuing jobs]delayed</em>job queuing jobs].\nThese are not generic and needed a little more work to extract them into custom jobs.</p>\n<p>Once our jobs were working, we had a bit of auditing to do.\nOur database is HIPAA-compliant because we are protected from unauthorized access and encrypt data in flight and at rest.\nSome of our jobs relied on that HIPAA-compliance and had protected health information (PHI) or personally identifiable information (PII) in the arguments to <code>#perform</code>, which are serialized in the job queue.\nThis was no longer acceptable in SQS, because it is not secure enough.\nWe had to move that data into the database and fetch it when executing the job.</p>\n<h3>Multiple queues</h3>\n<p>Our background jobs have a number of different performance profiles.\nSome jobs are relatively quick, but numerous; other jobs are not as numerous but take on the order of minutes rather than seconds.\nWe have split our jobs into five different job queues to prioritize jobs better and avoid starving any particular kind of job.</p>\n<p>In delayed_job, the queue is just a column in the database table.\nWhen the worker starts, it polls a subset of queues and executes jobs it finds.</p>\n<p>With Elastic Beanstalk and SQS, each queue is physically separate, and each worker polls a single queue.\nThis means we need five separate worker environments to poll those five queues.</p>\n<p>A consequence of SQS's fully-realized queues is that the queues are no longer scoped to a single application; they share a global namespace within our AWS account.\nOur jobs all had hard-coded the logical queue name since it had just been stored in the database.\nNow, we needed to use environment variables to name each queue so the name could be determined at deploy-time.</p>\n<h3>Tracking pending jobs</h3>\n<p>In some cases, the result of a background job is made available to providers or patients, and we want to track the job until it is done to indicate that work is incomplete.</p>\n<p>With delayed_job, we could write database queries to do this.\nThe queries were a little messy since things like IDs are encoded in the <code>handler</code> as YAML, but querying was at least possible.</p>\n<p>SQS provides little visibility into pending messages.\nIts queues have simple receive-or-send interfaces.\nAdditionally, once a job is picked up by a worker, it becomes invisible to any other consumers for the duration of the <code>VisibilityTimeout</code> (more on this later).</p>\n<p>We decided to implement a job-tracking system ourselves using the <a href=\"http://guides.rubyonrails.org/v4.2/active_job_basics.html#callbacks\">built-in hooks of ActiveJob</a>.\nWe create a pending event for a particular job in <code>before_enqueue</code>, then create more events in <code>before_perform</code> and <code>after_perform</code>.\nThis solution has the added benefit of not being tied to any particular ActiveJob backend and will continue to work even if we migrate away from SQS.</p>\n<h3>Race conditions</h3>\n<p>Using ActiveJob callbacks helps expose another issue that SQS is affected by differently than delayed<em>job: race conditions.\nWith delayed</em>job, all work is done in database transactions, which keeps the producer (the web server) and the consumer (the job executor) in sync.\nWith SQS the queue is no longer synchronized with the data and can introduce race conditions.</p>\n<p>The general pattern of code affected by race conditions was enqueuing a job from within a database transaction.\nThis usually involved one of two things:</p>\n<ul>\n<li>enqueuing a job from within an explicit <code>ActiveRecord::Base::transaction</code></li>\n<li>enqueuing a job from within an ActiveRecord callback (e.g. <code>after_create</code>), which are also within transactions</li>\n</ul>\n<p>The latter was fixed by switching to <code>after_commit on: :create</code>.\nThe former was fixed by moving the enqueue outside the transaction, which was sometimes trivial and sometimes not.</p>\n<h3>Retrying</h3>\n<p>When a background job fails, it is often retried some amount of time later in the hopes that the failure was transient.\nA common pattern is to retry using <a href=\"https://en.wikipedia.org/wiki/Exponential_backoff\">exponential backoff</a>, which is what delayed<em>job does by default.\nOur jobs would try up to 10 attempts, which using [delayed</em>job's exponential backoff]<a href=\"https://github.com/collectiveidea/delayed_job/tree/v4.1.1#custom-jobs\">custom jobs</a> resulted in a total time span of 4.27 hours between initial execution and the final attempt.</p>\n<p>Retrying jobs in SQS is controlled by <a href=\"http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-visibility-timeout.html\">the <code>VisibilityTimeout</code> configuration</a> and the maximum receive count configured in <a href=\"http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html\">the redrive policy</a>.\nWhen a job executor receives a message, the message automatically becomes invisible to other consumers for the duration of the <code>VisibilityTimeout</code>.\nAfter this time, if the message has not been deleted yet, the receive will be counted as failed and the message will become available to consumers again, until the maximum receive count is reached.\nAs a consequence, if a job takes longer than the <code>VisibilityTimeout</code>, it may be performed more than once, even if it is successful.\nThe value of <code>VisibilityTimeout</code> should therefore be high enough for any job to complete.</p>\n<p>We decided to use the maximum allowed <code>VisibilityTimeout</code> of 30 minutes for our jobs.\nOccasionally some of our jobs take this long to process.\nAdditionally, with the same number of attempts we were already using (10), this would leave at minimum 4.5 hours between initial execution and the final attempt.\nAll of this would result in a similar timing profile after migrating to SQS.</p>\n<p>The <code>VisibilityTimeout</code> can be configured in two ways:</p>\n<ul>\n<li>a static value configured in the queue</li>\n<li>a value from the consumer when using the ReceiveMessage API</li>\n</ul>\n<p>In the case of background job execution, <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html#worker-daemon\">the AWS SQS daemon</a> uses the second option via <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html#command-options-general-elasticbeanstalksqsd\">its own configuration</a>.</p>\n<p>Since the SQS daemon uses an HTTP POST request to execute jobs, there's one more, hidden, piece of configuration: nginx's <code>proxy_read_timeout</code>.\n<a href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_read_timeout\">By default, this is only 60 seconds</a>.\nAfter that time, nginx returns a 504 timeout error status to the daemon, and the job is considered failed.\nWe had to increase this to match our <code>VisibilityTimeout</code> by adding <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-commands\">an ebextension with a command</a> to our application:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>commands:\n  worker_configure_nginx:\n    command: |\n      echo 'proxy_read_timeout 1800s;' \\\n        >> /etc/nginx/conf.d/nginx.conf\n    test: test -f /opt/elasticbeanstalk/lib/ruby/bin/aws-sqsd</code></pre>\n      </div>\n<p>We also have <a href=\"https://github.com/heroku/rack-timeout\">rack-timeout</a> loaded in our application to terminate long-running requests, which needed a similar adjustment.</p>\n<h3>Health check</h3>\n<p>The AWS SQS daemon performs its own health check to <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html#command-options-general-elasticbeanstalkapplication\">the Application Healthcheck URL</a> to ensure that the application can accept jobs to execute.\nUnfortunately, while the load balancer can support <a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">end-to-end encryption</a> and perform a health check over HTTPS, the SQS daemon cannot.\nIn a worker environment, the Application Healthcheck URL must be HTTP.</p>\n<p>We <a href=\"https://github.com/onemedical/elastic_beans#health-check\">added a middleware to <code>elastic_beans</code></a> to handle these health checks if the request looks like it's from the SQS daemon: it's from localhost, and is a GET request to <code>/</code>.</p>\n<h2>Configuring with <code>elastic_beans</code></h2>\n<p>We created a Rails initializer to use the middleware provided by <code>elastic_beans</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>require \"elastic_beans/rack/health_check\"\n\nif Rails.configuration.force_ssl\n  Rails.configuration.middleware.insert_before(\n    ActionDispatch::SSL,\n    ElasticBeans::Rack::HealthCheck,\n    logger: Rails.logger,\n  )\nelse\n  Rails.configuration.middleware.use(\n    ElasticBeans::Rack::HealthCheck,\n    logger: Rails.logger,\n  )\nend</code></pre>\n      </div>\n<p>Creating worker environments using <code>elastic_beans</code> involved a couple steps.\nFirst we set up CloudFormation outputs that <code>elastic_beans</code> could discover when configuring the application.\nWe created our Elastic Beanstalk application using a CloudFormation template that also created other AWS resources needed by the application, including our five worker queues in SQS.\nWe added those queue URLs to the outputs of the <code>myapp</code> CloudFormation stack following the convention that <code>elastic_beans</code> understands: <code>Worker${Queue}QueueUrl</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>\"Outputs\": {\n  \"WorkerDefaultQueueUrl\": {\n    \"Value\": {\"Ref\": \"WorkerDefaultQueue\"}\n  },\n  \"WorkerMailersQueueUrl\": {\n    \"Value\": {\"Ref\": \"WorkerMailersQueue\"}\n  }\n}</code></pre>\n      </div>\n<p>Then, after <a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">running <code>beans configure</code> to set up the application</a>, we could create worker environments for each queue:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans create worker -q default -a myapp\nbeans create worker -q mailers -a myapp</code></pre>\n      </div>\n<h2>Reflections</h2>\n<p>We outlined a lot of challenges in migrating from delayed_job to SQS, but overall this went pretty smoothly.\nA little forethought and testing meant we hardly noticed the difference.\nThe biggest surprises were race conditions and the lack of HTTPS support from the SQS daemon health check.</p>\n<p>This was an exciting change for us to be able to make.\nWe had already outgrown delayed_job, and migrating our application to Elastic Beanstalk ended up being a perfect way to switch job queuing systems.</p>\n<h2>Elastic Beanstalk Migration</h2>\n<p>Overall the migration process has been fairly straightforward.\n<code>elastic_beans</code> has helped the Core Infrastructure group spare the rest of the team from most of these difficulties.\nWe are excited to be using a more secure, compliant, and scalable hosting platform!</p>\n<p>In future articles in this series, I will cover some of the issues we have overcome and how <code>elastic_beans</code> helps us solve them.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li>Migrating Background Jobs to SQS</li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>","fields":{"slug":"/elastic-beanstalk-migrating-background-jobs-to-sqs","post":{"title":"Elastic Beanstalk: Migrating Background Jobs to SQS","link":null,"timestamp":"2017-02-09T18:20Z","date":"February 9, 2017 6:20pm UTC"}}}},{"node":{"html":"<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABy2LmaoAn/8QAGRAAAwEBAQAAAAAAAAAAAAAAAQIRABAh/9oACAEBAAEFAl9LLNcphvP/xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BgX//xAAVEQEBAAAAAAAAAAAAAAAAAAAQIf/aAAgBAgEBPwGn/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRABAQEBAQEAAAAAAAAAAAAAAQARITGB/9oACAEBAAE/IQ4Bv2QmhcSElp9nr7f/2gAMAwEAAgADAAAAEC//AP/EABcRAAMBAAAAAAAAAAAAAAAAAAEQESH/2gAIAQMBAT8QENX/xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8Qbop//8QAGhABAQEBAQEBAAAAAAAAAAAAAREAIUFRYf/aAAgBAQABPxAFVsnC5sBT7c2iN/OTMHEbkHS9981qqX67/9k='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Chain link fence in focus with blurry city lights behind\"\n        title=\"\"\n        src=\"/static/0e416124fe3a62ed68c2b446728e78a7/fa9d5/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg\"\n        srcset=\"/static/0e416124fe3a62ed68c2b446728e78a7/30a96/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 240w,\n/static/0e416124fe3a62ed68c2b446728e78a7/288d4/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 480w,\n/static/0e416124fe3a62ed68c2b446728e78a7/fa9d5/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 960w,\n/static/0e416124fe3a62ed68c2b446728e78a7/78106/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 1440w,\n/static/0e416124fe3a62ed68c2b446728e78a7/fb391/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 1920w,\n/static/0e416124fe3a62ed68c2b446728e78a7/11ea9/elastic-beanstalk-end-to-end-encryption-and-private-networking.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  \nPhoto by <a href=\"https://unsplash.com/photos/Zw2-HhnCV2U\">Yannik Wenk</a> on <a href=\"https://unsplash.com/\">Unsplash</a></p>\n<p>This article is part of a series on migrating to <a href=\"https://aws.amazon.com/elasticbeanstalk/\">Elastic Beanstalk</a> from a <a href=\"http://12factor.net/\">12-factor</a> application platform.\nIt also introduces <a href=\"https://github.com/onemedical/elastic_beans\">our <code>elastic_beans</code> CLI</a>, a replacement for the built-in AWS eb CLI.\nFor an explanation of why we chose Elastic Beanstalk, and why we chose to write a replacement CLI, see <a href=\"./migrating-to-elastic-beanstalk\">the first article in the series</a>.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li>End-to-End Encryption and Private Networking</li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>\n<p>Security is our priority, and ensuring we protect our patients' data was a major focus for this migration.\nWe must protect network traffic, data stored on our servers, and data stored on our clients.\nClient access to data is outside the scope of this series, but in this document I will discuss network architecture and end-to-end encryption on Elastic Beanstalk.</p>\n<h2>Network architecture</h2>\n<p>Running on a public platform meant we couldn't take much advantage of firewalls.\nInstead we had to rely only on authentication to protect access to our data.\nMigrating to Elastic Beanstalk afforded us the opportunity to rethink our application's network architecture.</p>\n<p>Using a <a href=\"https://aws.amazon.com/vpc/\">Virtual Private Cloud (VPC)</a>, we can segregate our instances by their traffic patterns.\nWe create three subnets in each availability zone we want to use: one for application instances, one for load balancers, and one for <a href=\"https://en.wikipedia.org/wiki/Bastion_host\">a bastion server</a>.\nEach subnet has a route table and a security group that is specific to its function.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 936px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 107.6923076923077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAACWklEQVQ4y6VUTU8bMRDlV/avVO2de4899NY/QIWEaHvqrYKiUhXUZoEsCST7wa7t+Gv87U42QQJpOUR9slaWPG/med5493LOXnaON3l37AWrm6/7i8PXfPIlPkMY1hYppREyr4rpp7ez4/3pwRsQfYjJOesQFr/WD7DrvRshG71qL44YaZVSPgSMwjp4oJpCtYWPGVMYa40xI2StJHT32dgExnNuV9xyHjXIh8aSLlgfjQNCJCEZTFQ6A+BpGgogWRml75b1sm4cFncueJ9TMlobsP7+Upe/OONC8BDwxK+wgBB5uMVAlrL6/KGbTQCsBq0BnEcRXBnffT/oTo/EOkTGoWcXfy5J0+QQBrIUTgH7ccwmZ6uqhdu5u1uERa3KuacM0zmu9HUpb27TsklSWlTHefKbyhqs1GAsagJCJWWKsgBgOMdyD9VSUgJc6NUKpSZrs/cJ77VpGKvL7vb3sm4Xy0Vb1QbtiRHbjh1G8Rt/ffDOb61Kw9qSRV/JembAR601pWjpNiimjcPDqCQX4phVYBzt1dWZkQLQp0fyY4roU9Z1Kb59RCOwJqWUkH5LBhdVcVK9e/XQt4IL95ychw73s0l5+N6tVcTp9LooJo9k7E1Vs9OTNJ1bQvGqacDTBNpYpsxm8p7LRnR99bcgVze6J6MzjDTvx2ZbcM4IWiS41qzvGaVt2xJC7BOguvGHEZzzxlBGMb1Vev0UQ9i8wacYf88Yq4U8P/+ppPQ48S/EvUD2AZSSBsK6sso7kVEkis5MJMIANzv9htbTtxKuvPPzRZBqN3L+D/wDlbf7BMMcji4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Networking diagram representing this article\"\n        title=\"\"\n        src=\"/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png\"\n        srcset=\"/static/97334c0fb410a8401865592c76d19a92/31d41/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 240w,\n/static/97334c0fb410a8401865592c76d19a92/2741e/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 480w,\n/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 936w\"\n        sizes=\"(max-width: 936px) 100vw, 936px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>The application route table uses a <a href=\"http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html\">NAT gateway</a> to allow egress traffic to reach the outside internet.\nThe application security group allows only HTTP and HTTPS ingress traffic (ports 80 and 443), and only from the load balancer security group.\nIn turn the load balancer security group allows only HTTP and HTTPS ingress traffic, but from anywhere.\nThe route table for the load balancer subnet uses an internet gateway to route traffic, because the subnet is only for publicly-accessible nodes.</p>\n<p>The bastion subnet shares a route table with the load balancer subnet because it is also intended for public access.\nHowever its security group only allows SSH ingress traffic (port 22).\nWe have one more security group to allow SSH ingress traffic from the bastion server to the application instances.</p>\n<p>These resources must all exist separately in each of development, staging, and production environments.\nUsing [CloudFormation][] we can write a template encoding these resources and relationships and deploy it in each environment.\nThe <code>elastic_beans</code> wiki has <a href=\"https://github.com/onemedical/elastic_beans/wiki/Getting-started#create-a-networking-stack\">an example</a> that includes everything necessary.</p>\n<h3>Integration with Elastic Beanstalk</h3>\n<p><a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/vpc.html#d0e54425\">Elastic Beanstalk supports a VPC public/private network architecture</a> like this one, but requires some configuration before creating instances.\n<code>elastic_beans</code> will configure this automatically using the <code>configure</code> command, given the appropriate CloudFormation stack.\nUsing CloudFormation is a best practice that also minimizes the number of arguments we must pass to <code>elastic_beans</code>.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development</code></pre>\n      </div>\n<p>This command assumes we have already <a href=\"https://github.com/onemedical/elastic_beans/wiki/Getting-started#create-a-networking-stack\">created our Elastic Beanstalk application</a> and named it <code>myapp</code>.\n<code>elastic_beans</code> fetches the appropriate details from the Outputs configured in the template and sets them in configuration templates, also known as saved configurations.\nAny applications we create using <code>elastic_beans</code> will use the correct configuration template and be created in our desired network layout.</p>\n<p>We can re-use this networking stack for more applications if we are comfortable with them sharing a network.\nThis is useful for development environments that will not contain sensitive data.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a another-app -n networking-development</code></pre>\n      </div>\n<h3>Bastion server</h3>\n<p>The <a href=\"https://en.wikipedia.org/wiki/Bastion_host\">bastion server</a> serves as an SSH proxy if we need shell access to our application instances.\nDuring the <code>configure</code> command, <code>elastic_beans</code> found our security group allowing access from the bastion server to our application instances and added it to the Elastic Beanstalk configuration.\nNow, if we have the private key and public IP address for the bastion server and the private IP address of the application instance we want to access, we can proxy through the bastion using <code>ssh</code>.\n<code>elastic_beans</code> also automates this for us:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans ssh webserver -a myapp \\\n  -i $KEYPAIR \\\n  --bastion-host $BASTION_IP --bastion-username $USER \\\n  --bastion-identity-file $PRIVATE_KEY</code></pre>\n      </div>\n<p>That said, shell access is rarely needed.\nDebugging is more effective using metrics and log aggregation and searching and monitoring in those places.\nInstead of running commands in an SSH session, commands are run using <code>beans exec</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans exec rake db:migrate -a myapp</code></pre>\n      </div>\n<p>Due to how powerful a local user can be, adequate protection of the bastion server is essential.\nBeyond attack and vulnerability mitigation, normal access must be controlled.\nAuditing access, protecting it behind multi-factor authentication, and good policy and access control are examples of ways to do this.</p>\n<h2>End-to-end encryption</h2>\n<p>Once our network is appropriately constructed, we can focus on protecting data in transit and at rest on our servers.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 936px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 107.6923076923077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAACWklEQVQ4y6VUTU8bMRDlV/avVO2de4899NY/QIWEaHvqrYKiUhXUZoEsCST7wa7t+Gv87U42QQJpOUR9slaWPG/med5493LOXnaON3l37AWrm6/7i8PXfPIlPkMY1hYppREyr4rpp7ez4/3pwRsQfYjJOesQFr/WD7DrvRshG71qL44YaZVSPgSMwjp4oJpCtYWPGVMYa40xI2StJHT32dgExnNuV9xyHjXIh8aSLlgfjQNCJCEZTFQ6A+BpGgogWRml75b1sm4cFncueJ9TMlobsP7+Upe/OONC8BDwxK+wgBB5uMVAlrL6/KGbTQCsBq0BnEcRXBnffT/oTo/EOkTGoWcXfy5J0+QQBrIUTgH7ccwmZ6uqhdu5u1uERa3KuacM0zmu9HUpb27TsklSWlTHefKbyhqs1GAsagJCJWWKsgBgOMdyD9VSUgJc6NUKpSZrs/cJ77VpGKvL7vb3sm4Xy0Vb1QbtiRHbjh1G8Rt/ffDOb61Kw9qSRV/JembAR601pWjpNiimjcPDqCQX4phVYBzt1dWZkQLQp0fyY4roU9Z1Kb59RCOwJqWUkH5LBhdVcVK9e/XQt4IL95ychw73s0l5+N6tVcTp9LooJo9k7E1Vs9OTNJ1bQvGqacDTBNpYpsxm8p7LRnR99bcgVze6J6MzjDTvx2ZbcM4IWiS41qzvGaVt2xJC7BOguvGHEZzzxlBGMb1Vev0UQ9i8wacYf88Yq4U8P/+ppPQ48S/EvUD2AZSSBsK6sso7kVEkis5MJMIANzv9htbTtxKuvPPzRZBqN3L+D/wDlbf7BMMcji4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Networking diagram representing this article\"\n        title=\"\"\n        src=\"/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png\"\n        srcset=\"/static/97334c0fb410a8401865592c76d19a92/31d41/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 240w,\n/static/97334c0fb410a8401865592c76d19a92/2741e/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 480w,\n/static/97334c0fb410a8401865592c76d19a92/255b7/elastic-beanstalk-end-to-end-encryption-and-private-networking-1.png 936w\"\n        sizes=\"(max-width: 936px) 100vw, 936px\"\n      />\n    </span>\n  </span>\n  </p>\n<h3>Data in transit</h3>\n<p>There are a couple different places we must encrypt data in transit.</p>\n<ul>\n<li>Clients send data to the ELB that Elastic Beanstalk creates</li>\n<li>The ELB sends data to application instances</li>\n</ul>\n<p>I will discuss both of these. There are a lot of other ways data is transmitted that I will not discuss, because the solutions are less reusable:</p>\n<ul>\n<li>SSH clients can access data by virtue of being on a host</li>\n<li>Data is sent to various services, e.g. stored in RDBMS or key-value store, indexed by a search service, integrated with third parties</li>\n<li>Logs are sent to a log aggregation service</li>\n</ul>\n<p>Protecting each of these data transmissions is outside the scope of this article.\nThe solutions are specific to the service and methods in use.\nThe basic guiding principle is: all network access should be encrypted and trusted.</p>\n<h3>Clients send data to the ELB</h3>\n<p>To protect data in transit from a client to our load balancer, we use HTTPS.\nElastic Load Balancers are configured with a listener for HTTPS traffic coupled with an IAM server certificate.\nElastic Beanstalk can be configured to <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https.html\">set up its load balancers for HTTPS traffic</a>.\n<code>elastic_beans</code> automates this configuration for us! Given that we have our own domain and a valid certificate for that domain, we can upload it along with its private key and the certificate chain for our certificate authority (CA).\nOnce uploaded, we have an ARN representing that certificate within IAM.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>$ aws iam upload-server-certificate ...\n{\n    \"ServerCertificateMetadata\": {\n        \"ServerCertificateId\": \"...\",\n        \"ServerCertificateName\": \"...\",\n        \"Expiration\": \"...\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::123456789012:server-certificate/elastic-beanstalk-x509\",\n        \"UploadDate\": \"...\"\n    }\n}</code></pre>\n      </div>\n<p>We pass that ARN to <code>elastic_beans</code> so it can configure all of the Elastic Beanstalk option settings automatically for us. 🎉</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development \\\n  -s arn:aws:iam::123456789012:server-certificate/elastic-beanstalk-x509</code></pre>\n      </div>\n<h3>ELB sends data to application instances</h3>\n<p>With a server certificate configured on our ELB, it will decrypt traffic at that point.\nThis means data is passed around within our VPC unencrypted, which is unacceptable.\nUnencrypted data over a network connection, even within a VPC, could be leaked, intentionally or unintentionally.\nWe can encrypt data that is passed from the ELB to our application instances:</p>\n<ul>\n<li><a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-ruby.html#Puma\">configure nginx to listen for HTTPS traffic with an SSL certificate and private key</a></li>\n<li><a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-endtoend.html\">configure a backend policy on the ELB with the public key for that certificate</a></li>\n</ul>\n<p>Since this certificate is only used internally, we can self-sign a certificate, or use a valid certificate.\nSecurity groups were defined in our CloudFormation stack following the guidelines from the \"Network Architecture\" section discussed earlier.\n<code>elastic_beans</code> will use those and set up our ELB listeners correctly.\nA future version of <code>elastic_beans</code> could generate an internal certificate and set up an HTTPS server on nginx automatically; for now, our application must configure nginx and give <code>elastic_beans</code> the public key for the load balancer.</p>\n<p>We set up an <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\"><code>.ebextensions</code> configuration</a> for nginx following the directions from the first bullet point above.\nIt creates files with our certificate and private key, and adds nginx configuration for an HTTPS server using the certificate and private key.\nWe can find our public key using <code>openssl</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>$ openssl x509 -in ./cert.crt -noout -pubkey\n-----BEGIN PUBLIC KEY-----\nSOMEPUBLICKEYCONTENTS\n-----END PUBLIC KEY-----</code></pre>\n      </div>\n<p>Then we can pass the contents of the public key to <code>beans configure</code> to set up the ELB backend policy:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development \\\n  -p 'SOMEPUBLICKEYCONTENTS'</code></pre>\n      </div>\n<h3>Data at rest</h3>\n<p>The data from a request generally does not reach the disk, but it is logged and our log files are stored on disk.\nWe can <a href=\"https://aws.amazon.com/blogs/aws/new-encrypted-ebs-boot-volumes/\">encrypt the AMIs</a> provided by Elastic Beanstalk and configure our application to use the encrypted versions.\nFirst we must create our own copy of the image, then we can encrypt it using a key from Amazon KMS, and clean up the unencrypted copy.\nWe've automated this in our continuous integration system so that every new Elastic Beanstalk image is copied and encrypted.</p>\n<p>Once we have an encrypted image, we use <code>elastic_beans</code> to configure our servers to use it instead of the default.\nExisting instances will be re-created, and any new environments or instances will be created using this image.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a myapp -n networking-development \\\n  -i $AMI_ID</code></pre>\n      </div>\n<h2>Configuring with <code>elastic_beans</code></h2>\n<p>All together, the options discussed in this article are used by <code>beans configure</code> to set up an Elastic Beanstalk application for end-to-end encryption.\nThis saves us a lot of manual work on every application we set up!</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>beans configure -a $APP_NAME \\\n  -n $NETWORKING_CLOUDFORMATION_STACK \\\n  -i $AMI_ID \\\n  -s $SERVER_CERTIFICATE_ARN \\\n  -p $PUBLIC_KEY</code></pre>\n      </div>\n<h2>Elastic Beanstalk Migration</h2>\n<p>Overall the migration process has been fairly straightforward.\n<code>elastic_beans</code> has helped the Core Infrastructure group spare the rest of the team from most of these difficulties.\nWe are excited to be using a more secure, compliant, and scalable hosting platform!</p>\n<p>In future articles in this series, I will cover some of the issues we have overcome and how <code>elastic_beans</code> helps us solve them.</p>\n<ol>\n<li><a href=\"./migrating-to-elastic-beanstalk\">Migrating to Elastic Beanstalk</a></li>\n<li>End-to-End Encryption and Private Networking</li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>","fields":{"slug":"/elastic-beanstalk-end-to-end-encryption-and-private-networking","post":{"title":"Elastic Beanstalk: End-to-End Encryption and Private Networking","link":null,"timestamp":"2017-02-08T18:20Z","date":"February 8, 2017 6:20pm UTC"}}}},{"node":{"html":"<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 960px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 58.099999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAABhmdIIKE//8QAGRAAAwADAAAAAAAAAAAAAAAAAQIDABAT/9oACAEBAAEFAujKXoxhpqErn//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/Aaf/xAAaEAACAgMAAAAAAAAAAAAAAAABEAAhEjJB/9oACAEBAAY/AqhOtvDi/8QAHBAAAwABBQAAAAAAAAAAAAAAAAERMRAhQVFh/9oACAEBAAE/Ic826ZLGBJrkfrJVS1SXp//aAAwDAQACAAMAAAAQPB//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPxCH/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/EBZP/8QAGhABAAMAAwAAAAAAAAAAAAAAAQARITFhof/aAAgBAQABPxAQHQ4VkZLVgudv0mm1V52JVraLB6C0Aavcqf/Z'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"The view from our brainstorming location\"\n        title=\"\"\n        src=\"/static/29273c4e38be3feebf674bc40d1ae496/fa9d5/migrating-to-elastic-beanstalk.jpeg\"\n        srcset=\"/static/29273c4e38be3feebf674bc40d1ae496/30a96/migrating-to-elastic-beanstalk.jpeg 240w,\n/static/29273c4e38be3feebf674bc40d1ae496/288d4/migrating-to-elastic-beanstalk.jpeg 480w,\n/static/29273c4e38be3feebf674bc40d1ae496/fa9d5/migrating-to-elastic-beanstalk.jpeg 960w,\n/static/29273c4e38be3feebf674bc40d1ae496/78106/migrating-to-elastic-beanstalk.jpeg 1440w,\n/static/29273c4e38be3feebf674bc40d1ae496/fb391/migrating-to-elastic-beanstalk.jpeg 1920w,\n/static/29273c4e38be3feebf674bc40d1ae496/11ea9/migrating-to-elastic-beanstalk.jpeg 2000w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>As any app or company grows and scales, your hosting needs change.\nThis is a fact of life that we all deal with.\n1Life, our electronic health record (EHR), is a Rails application that for years had been deployed to a <a href=\"https://12factor.net\">12-factor</a> application platform that we were now outgrowing.\nThis was an opportunity for us to improve our platform, compliance, and security.\nIt was also quite a technical challenge!</p>\n<p>I'm a full-stack engineer on the Technology team at One Medical, who loves operations and is full of opinions on the right way to run a web app.\nAs a member of the Core Infrastructure team, I had the opportunity to work on this project from start to finish.\nI want to walk you through our journey to a new hosting platform.\nIt was challenging, long, and uncertain, and I hope our experience can help you if you're working on a similar migration.</p>\n<h2>Research</h2>\n<p>In theory we could just move our 12-factor compliant code somewhere else, but in reality there are all sorts of particulars not covered by the 12-factor model. Additionally, our code base had been around for close to 10 years at the time of this migration, so there were some potential \"unknown unknowns.\" As we walked into our all-day offsite to explore our options, we needed some criteria to evaluate solutions. We wanted:</p>\n<ul>\n<li>to use the AWS cloud, which <a href=\"aws-hipaa\">is HIPAA-compliant</a> and has a signed BAA with us</li>\n<li>simple environment management - a great developer experience with minimal code or operations required</li>\n<li>vertical and horizontal scaling</li>\n<li>health monitoring and auto-healing</li>\n<li>log aggregation</li>\n<li>rollback</li>\n<li>rolling upgrades</li>\n<li>support for scheduled tasks, one-off tasks, and Rails console sessions</li>\n</ul>\n<p>Then we spent some time considering, investigating, and testing different solutions for hosting 1Life. Our two favorite options were the new EC2 Container Service (ECS), or Elastic Beanstalk. Long story short, we landed on Elastic Beanstalk to host 1Life. Elastic Beanstalk took care of two key operational needs that ECS would require us to do: cluster management and container building.</p>\n<p><img src=\"./migrating-to-elastic-beanstalk-1.gif\" alt=\"a beanstalk growing in time-lapse\"></p>\n<h2>Elastic Beanstalk</h2>\n<p>AWS <a href=\"https://aws.amazon.com/elasticbeanstalk/\">Elastic Beanstalk</a> is a fully-managed application platform.\nThat means we only worry about our application and its interface to Elastic Beanstalk.\nAmazon manages the operating system, compatibility, and security updates, while meeting almost all of our criteria.\nIt's also straightforward to extend with implementations of the criteria it doesn't already support.\nIt supports running instances in a private network inside a VPC.\nFinally, it comes with <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3.html\">a CLI</a> that enables developers to execute common tasks.</p>\n<p>In Elastic Beanstalk, an application has many environments.\nEach environment is a single-purpose collection of servers.\nIf you've used <a href=\"https://devcenter.heroku.com/articles/procfile\">a Procfile</a> before, each line of the Procfile could be considered an environment.\nThe two basic examples are the <code>webserver</code> environment and the <code>worker</code> environment.\nEach instance of our application uses several worker environments to support multiple ActiveJob queues, and a separate scheduled task worker environment.\nEach environment has its own auto-scaling group that keeps enough instances running to meet our needs.</p>\n<p>Using <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\"><code>.ebextensions configuration</code></a>, we can meet some of our other requirements.</p>\n<ul>\n<li>We encrypt Elastic Beanstalk AMIs and add nginx configuration to <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-ruby.html#Puma\">encrypt data end-to-end</a>, in flight and at rest.</li>\n<li>Logs are uploaded to our log aggregation service by running a collection agent on the application instance.</li>\n</ul>\n<h3>Limitations</h3>\n<p>Elastic Beanstalk makes some assumptions about how your applications work that don't always play nicely with a real Rails application.\nIt only <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/concepts.platforms.html\">supports a limited combination of major language versions and software</a>.\nThat's not a big deal, but it means we need to support the right application server and Ruby version.\nMore restrictive, [worker environments][environments] receive jobs from SQS and execute them via HTTP POST requests from a local daemon.\nThese are things we can work around without requiring significant changes to our application.\nWorker environments can use the <a href=\"https://github.com/tawan/active-elastic-job\">active-elastic-job gem</a> as the ActiveJob backend.</p>\n<p>The CLI is pretty handy, but not complete:</p>\n<ul>\n<li>The VPC support in <code>eb create</code> is great, but it ends there. Connecting to instances inside a VPC requires manual SSH gateway setup.</li>\n<li>The CLI <a href=\"http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebcli-compose.html\">supports multiple environments</a>, but only in a rigid fashion that isn't usable when those environments share the same codebase.</li>\n<li>Upgrading running applications to a new version of the platform should be easy with <code>eb upgrade</code>, but using a custom AMI to support on-disk encryption means we can't use that command.</li>\n</ul>\n<p>None of these were dealbreakers. To address these limitations, we wrote our own CLI, <a href=\"https://github.com/onemedical/elastic_beans\">elastic_beans</a>.</p>\n<h3>elastic_beans</h3>\n<p><code>elastic_beans</code> is an opinionated but flexible tool.\nIt is written for Rails applications so it can implement best practices and make assumptions based on that.\nWe used Ruby to implement it so that its users, Rails developers, can more easily contribute.</p>\n<p>During setup it will configure your application to meet the best-practice criteria for a HIPAA-compliant Rails application.\nThere's a lot to configure, so one of the opinions <code>elastic_beans</code> has is that you should use <a href=\"https://aws.amazon.com/cloudformation/\">CloudFormation</a> to set up your infrastructure.\nCloudFormation can expose the details <code>elastic_beans</code> needs through Outputs so it can look up information automatically.</p>\n<p>Using this CLI, we can automate tasks that are painful with the <code>eb</code> CLI.\n<code>elastic_beans</code> provides a standard configuration that is stored in configuration templates so environments can be started, terminated, and restarted at will.\nIt creates and scales those environments on demand.\nDeploys of code and updates to configuration or environment variables are applied to all environments simultaneously.\nTasks like running rake tasks, SSH access, and opening a Rails console are handled without putting more load on webservers or workers.</p>\n<p>We can also fill in gaps and surprises in Elastic Beanstalk functionality.\nElastic Beanstalk <a href=\"https://forums.aws.amazon.com/thread.jspa?messageID=618423&#x26;#618423\">imposes a 4096-byte limit on environment variables</a> because of its dependency on CloudFormation.\n<code>elastic_beans</code> manages environment variables in S3 to avoid this.\nPeriodic tasks are handled by Elastic Beanstalk, but every application would need to reimplement handling Elastic Beanstalk's method of executing them.\n<code>elastic_beans</code> can intercept these requests, enqueue them, and process them out of band, avoiding forcing tasks into the web request lifecycle and a maximum 30-minute timeout.</p>\n<h2>Migration</h2>\n<p>Overall the migration process has been fairly straightforward.\n<code>elastic_beans</code> has helped the Core Infrastructure group spare the rest of the team from most of these difficulties.\nWe are excited to be using a more secure, compliant, and scalable hosting platform!</p>\n<p>In future articles in this series, I will cover some of the issues we have overcome and how <code>elastic_beans</code> helps us solve them.</p>\n<ol>\n<li>Migrating to Elastic Beanstalk</li>\n<li><a href=\"./elastic-beanstalk-end-to-end-encryption-and-private-networking\">End-to-End Encryption and Private Networking</a></li>\n<li><a href=\"./elastic-beanstalk-migrating-background-jobs-to-sqs\">Migrating Background Jobs to SQS</a></li>\n<li><a href=\"./elastic-beanstalk-one-off-and-periodic-tasks\">Periodic Tasks</a></li>\n</ol>","fields":{"slug":"/migrating-to-elastic-beanstalk","post":{"title":"Migrating to Elastic Beanstalk","link":null,"timestamp":"2017-02-07T18:20Z","date":"February 7, 2017 6:20pm UTC"}}}},{"node":{"html":"<p>Usually when I need documentation for a RubyGem I'm working with, I go to <a href=\"http://www.rubydoc.info/gems\">RubyDoc.info</a>.\nToday, however, it was not responding.\nAfter catching up on Twitter it occurred to me that I could read the documentation locally since I already had the gem installed.</p>\n<p>Running <code>gem rdoc prawn</code><sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> generates documentation for the prawn gem.\nThen <code>gem server</code> will start a server on <code>localhost:8808</code> hosting the generated RDoc.</p>\n<p>This worked fine, but it occurred to me that starting and stopping the gem server whenever I want to see the documentation is annoying.\nOS X has the concept of <a href=\"https://developer.apple.com/library/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html\">launch agents</a> which can be kept alive by the operating system whenever you are logged in.\nI thought I would make a launch agent to run a gem server so that I could open it whenever I wanted.</p>\n<p>Unfortunately, running <code>gem server</code> in a default shell uses the version of Ruby that ships with OS X.\nI have gems installed in different versions of Ruby using <a href=\"https://github.com/postmodern/chruby\">chruby</a>, and I might want to see any of them depending on what project I'm working on.\nSo I decided to run a server for each version of Ruby I have installed (<em>except</em> the system Ruby).\nEach server runs on a different port chosen based on the Ruby version it supports.\nRuby 2.0.0 is available at <code>localhost:8200</code>, 2.1.4 is available at <code>localhost:8214</code>, and 2.2.1 is at <code>localhost:8221</code>.</p>\n<p>I wrote a script and an accompanying launch agent plist to run it and <a href=\"https://gist.github.com/adamstegman/76d9cb40a8a3d92ea0e6\">posted them in a gist</a>.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>There was one catch to generating the documentation. I keep my <code>~/.gemrc</code> with <code>gem: --no-ri --no-rdoc</code> so that bundle installs go quickly, but in this case it was causing the <code>gem rdoc</code> command to fail. I had to remove that option to successfully generate the documentation.</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/launchd-gem-servers-on-os-x","post":{"title":"Launchd Gem Servers on OS X","link":null,"timestamp":"2015-04-21T04:29Z","date":"April 21, 2015 4:29am UTC"}}}},{"node":{"html":"<p>While working on photo uploads in my <a href=\"https://github.com/adamstegman/photo_albums\">latest project</a>, I needed a network activity indicator to reflect background network usage.\nThat way, users could navigate away from the upload form and see that uploads were still going in the background.\nSince I'm using <a href=\"http://emberjs.com/\">Ember.js</a> I created a component to display the indicator.\nI created an array in my <code>ApplicationController</code> to track each upload.\nFor each element in the array, I rendered a network activity indicator.</p>\n<p>The concept was pretty straightforward and in a simple case worked fine.\nBut when I removed an indicator after an upload was done, I got a strange error:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>TypeError: Cannot read property 'destroy' of undefined\n    at Ember.CollectionView.Ember.ContainerView.extend.arrayWillChange (http://localhost:8888/assets/ember.js?body=true:23233:16)\n    at null._contentWillChange (http://localhost:8888/assets/ember.js?body=true:23140:10)\n    at sendEvent (http://localhost:8888/assets/ember.js?body=true:2302:14)\n    at notifyBeforeObservers (http://localhost:8888/assets/ember.js?body=true:2671:5)\n    at Object.propertyWillChange (http://localhost:8888/assets/ember.js?body=true:2497:3)\n    at set (http://localhost:8888/assets/ember.js?body=true:2763:15)\n    at Object.Ember.trySet (http://localhost:8888/assets/ember.js?body=true:2832:10)\n    at Object.Binding._sync (http://localhost:8888/assets/ember.js?body=true:6765:15)\n    at Object.DeferredActionQueues.flush (http://localhost:8888/assets/ember.js?body=true:5565:24)\n    at Object.Backburner.end (http://localhost:8888/assets/ember.js?body=true:5656:27)</code></pre>\n      </div>\n<p>The stacktrace indicated the problem is when I <code>set</code> the new array of uploads.\nFrom the description of <a href=\"http://emberjs.com/api/classes/Ember.CollectionView.html\"><code>Ember.CollectionView</code></a> it looked like the problem is with updating the rendered template from the array:</p>\n<blockquote>\n<p><code>Ember.CollectionView</code> is an <code>Ember.View</code> descendent responsible for managing a collection (an array or array-like object) by maintaining a child view object and associated DOM representation for each item in the array and ensuring that child views and their associated rendered HTML are updated when items in the array are added, removed, or replaced.</p>\n</blockquote>\n<p>Stack Overflow had <a href=\"http://stackoverflow.com/a/16661864\">an answer</a> that explained that the problem was with updating the property bindings:</p>\n<blockquote>\n<p><code>push</code> doesn't tell the binding to update, but <code>pushObject</code> does</p>\n</blockquote>\n<p>Since I was using a native JavaScript array, I was using native methods to add and remove uploads.\nI needed to use an <code>Ember.NativeArray</code> instead so that I could use it in my template.\nThis is possible using <code>Ember.A</code> to wrap an array-like object:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'uploadActivityIndicators'</span><span class=\"token punctuation\">,</span> Ember<span class=\"token punctuation\">.</span><span class=\"token function\">A</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'uploadActivityIndicators'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeObject</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n      </div>\n<p>From what I've read, this is typical of Ember—use Ember's replacements for native JavaScript concepts to avoid any surprises like this.\nThis is one reason why some people prefer Angular or React.\nI don't think this is enough of a reason to write off a framework, it's just a guideline of using Ember.\nIt makes it more complicated to learn but doesn't make it automatically bad.\nStill, I need to learn more about Angular and React so I can better compare the options.</p>","fields":{"slug":"/rendering-array-properties-in-ember-js","post":{"title":"Rendering array properties in Ember.js","link":null,"timestamp":"2014-08-23T23:39Z","date":"August 23, 2014 11:39pm UTC"}}}},{"node":{"html":"<p>I created an <a href=\"https://developer.apple.com/library/mac/documentation/cocoa/reference/ApplicationKit/Classes/NSTokenField_Class/Reference/Reference.html\">NSTokenField</a> and everything worked great with strings as tokens.\nWhen I created a representative class to use instead, I ended up with an error message and a blank token field.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token operator\">&lt;</span>NSTokenFieldCell<span class=\"token punctuation\">:</span> <span class=\"token number\">0x6080003c97e0</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> Failed to query display string <span class=\"token keyword\">for</span> a represented object <span class=\"token operator\">&lt;</span>HMCPhotoTag<span class=\"token punctuation\">:</span> <span class=\"token number\">0x608000422460</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span> Ignoring<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n      </div>\n<p>Turns out, I just set the <a href=\"https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ApplicationKit/Classes/NSControl_Class/Reference/Reference.html#//apple_ref/occ/instm/NSControl/objectValue\"><code>objectValue</code></a> before I set the delegate.\nSetting the delegate first meant the token field could transform my objects correctly.</p>","fields":{"slug":"/nstokenfield-failed-to-query-display-string-for-a-represented-object","post":{"title":"NSTokenField failed to query display string for a represented object","link":null,"timestamp":"2013-12-02T01:19Z","date":"December 2, 2013 1:19am UTC"}}}},{"node":{"html":"<p>Originally posted as a <a href=\"https://gist.github.com/adamstegman/5077010\">gist</a> in response to <a href=\"https://twitter.com/adamstegman/status/307944394445688832\">this twitter conversation</a>.</p>\n<p>I'm working on a Rails application that uses the <a href=\"http://archive.msdn.microsoft.com/ewsjavaapi\">Exchange Webservices API</a>. Unfortunately the EWS API has a weird package, but I thought that wouldn't be hard to overcome. So I wrote this script:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-ruby\"><code><span class=\"token keyword\">require</span> <span class=\"token string\">'java'</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">'vendor/lib/EWSJavaAPI_1.2.jar'</span>\n\n<span class=\"token keyword\">def</span> microsoft\n  <span class=\"token constant\">Java</span><span class=\"token punctuation\">:</span><span class=\"token symbol\">:Microsoft</span>\n<span class=\"token keyword\">end</span>\n\nversion <span class=\"token operator\">=</span> microsoft<span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span>webservices<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token constant\">ExchangeVersion</span><span class=\"token punctuation\">:</span><span class=\"token symbol\">:Exchange2010_SP1</span>\nservice <span class=\"token operator\">=</span> microsoft<span class=\"token punctuation\">.</span>exchange<span class=\"token punctuation\">.</span>webservices<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token constant\">ExchangeService</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">)</span>\n</code></pre>\n      </div>\n<p>Getting the ExchangeVersion enum worked fine, but trying to access the ExchangeService class resulted in this error:</p>\n<blockquote>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>NameError: missing class or uppercase package name (`microsoft.exchange.webservices.data.ExchangeService')\nget_proxy_or_package_under_package at org/jruby/javasupport/JavaUtilities.java:54\nmethod_missing at file:/Users/adam/.rvm/rubies/jruby-1.7.3/lib/jruby.jar!/jruby/java/java_package_module_template.rb:14\n(root) at lib/sandbox.rb:11</code></pre>\n      </div>\n</blockquote>\n<p>I thought the problem was with the package name, but the error is actually that the EWS API is missing its dependencies. It needed commons-httpclient and commons-logging-api on the classpath. I discovered this via clojure's error message for similar code:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-clojure\"><code>(import '(microsoft.exchange.webservices.data ExchangeService))</code></pre>\n      </div>\n<blockquote>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>ClassNotFoundException org.apache.commons.httpclient.HttpConnectionManager  java.net.URLClassLoader$1.run (URLClassLoader.java:366)</code></pre>\n      </div>\n</blockquote>\n<p>So the real issue here is JRuby's error message. Interestingly enough, JRuby did give me a better error once commons-httpclient was on the classpath:</p>\n<blockquote>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-none\"><code>MultiThreadedHttpConnectionManager.java:70:in `<clinit>': java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory</code></pre>\n      </div>\n</blockquote>\n<p>That told me commons-logging-api was also missing. JRuby should have told me that in the first place.</p>","fields":{"slug":"/jruby-nameerror-missing-class-or-uppercase-package-name","post":{"title":"JRuby NameError: missing class or uppercase package name","link":null,"timestamp":"2013-04-13T19:43Z","date":"April 13, 2013 7:43pm UTC"}}}},{"node":{"html":"<blockquote>\n<p>Imagine if we didn’t judge the author of the code by how few “WTFs” it generated, but instead by how fertile it was\nfor discussion? Or, imagine if every programmer was being judged by what they learned from the discussion. How would\nthat change things? better still, imagine if the “manager's” job was to facilitate the learning and get the\ndiscussion back on track when it strayed into fixing-the-code territory instead of to judge people by how much they\n\"contribute.\" That would be a breath of fresh air to most teams.</p>\n</blockquote>\n<p>An excellent point. Code reviews are valuable for getting eyes on the code, but I agree with Raganwald here that the\nmore valuable outcome is that everyone shares in the learning. I've thought of that as learning <em>about</em> the work that\nothers are doing, but Raganwald makes a good point that you learn from the <em>discussion</em> about the work that others are\ndoing.</p>","fields":{"slug":"/code-reviews","post":{"title":"Code Reviews","link":"http://raganwald.posterous.com/a-conjecture-about-code-reviews","timestamp":"2012-10-05T00:20Z","date":"October 5, 2012 12:20am UTC"}}}},{"node":{"html":"<blockquote>\n<p>pair programming works best with a large uncertain search space of problems and solutions. the closer to a solved\nproblem, the less it helps</p>\n</blockquote>\n<p>— <a href=\"https://twitter.com/KentBeck\">Kent Beck</a> (<a href=\"https://twitter.com/KentBeck\">@KentBeck</a>)</p>","fields":{"slug":"/kent-beck-on-pair-programming","post":{"title":"Kent Beck on Pair Programming","link":"https://twitter.com/KentBeck/status/253532726714580992","timestamp":"2012-10-04T01:29Z","date":"October 4, 2012 1:29am UTC"}}}},{"node":{"html":"<p>I'm writing a class in <a href=\"http://adamstegman.com/projects/git-push.html\">Git Push</a> to hold and fetch git blobs from\n<a href=\"http://developer.github.com/v3/git/blobs/\">Github</a>.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token keyword\">@interface</span> GHBlob <span class=\"token punctuation\">:</span> NSObject <span class=\"token operator\">&lt;</span>NSCopying<span class=\"token punctuation\">,</span> NSMutableCopying<span class=\"token operator\">></span>\n<span class=\"token keyword\">@property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> readonly<span class=\"token punctuation\">)</span> NSData <span class=\"token operator\">*</span>content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">@end</span>\n\n<span class=\"token keyword\">@implementation</span> GHBlob\n<span class=\"token keyword\">@synthesize</span> content <span class=\"token operator\">=</span> _content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">@end</span>\n</code></pre>\n      </div>\n<p>To support creating and updating blobs, I wrote a mutable subclass initialized\nin #mutableCopy from <a href=\"http://developer.apple.com/library/ios/#documentation/Cocoa/Reference/Foundation/Protocols/NSMutableCopying_Protocol/Reference/Reference.html#//apple_ref/occ/intf/NSMutableCopying\">NSMutableCopying</a>. This entailed\nredefining properties as <code>readwrite</code>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token keyword\">@interface</span> GHMutableBlob <span class=\"token punctuation\">:</span> GHBlob\n<span class=\"token keyword\">@property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> readwrite<span class=\"token punctuation\">)</span> NSData <span class=\"token operator\">*</span>content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">@end</span>\n\n<span class=\"token keyword\">@implementation</span> GHMutableBlob\n<span class=\"token keyword\">@synthesize</span> content <span class=\"token operator\">=</span> _content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">@end</span>\n</code></pre>\n      </div>\n<h3>Problems</h3>\n<h4>Resynthesizing</h4>\n<p>As shown above, I also re-synthesized the methods in the subclass. However,\nthis resulted in the subclass's initializer breaking.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code>GHBlob <span class=\"token operator\">*</span>newBlob <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>blob mutableCopy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">STAssertEquals</span><span class=\"token punctuation\">(</span>newBlob<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span> blob<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span> nil<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//=> '&lt;00000000>' should be equal to '&lt;10cbb806>'</span>\n</code></pre>\n      </div>\n<p>On review, I noticed something I'd missed before in\n<a href=\"http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/ObjectiveC/Chapters/ocProperties.html\">Apple's documentation on redeclaring properties</a>. The redeclared\nproperty isn't synthesized in their example, it's declared <code>@dynamic</code> and the\nsetter is defined by hand. I scoffed at the inconvenience (isn't this what\nsynthesizing is supposed to avoid?), but did it anyway.</p>\n<h4>Unreachable instance variables</h4>\n<p>Next, the compiler complained that the <code>_content</code> instance variable was\nunreachable. Oh,\n<a href=\"http://stackoverflow.com/questions/5015130/do-properties-have-to-be-declared-as-instance-variables-in-objective-c#answer-5015657\">so <em>this</em> is why we define ivars in the interface</a> - it makes\nthem available to subclasses.</p>\n<h3>Summary</h3>\n<p>So to implement <code>NSMutableCopying</code>, I had to explicitly declare my instance\nvariables in the interface and explicitly define setter methods in my mutable\nsubclass. I thought the property/synthesize syntax was\n<a href=\"http://mobile.dzone.com/news/open-letter-apple-please-kill\">saving me the trouble</a>, but apparently it's not all rainbows and\nunicorns.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token keyword\">@interface</span> GHBlob <span class=\"token punctuation\">:</span> NSObject <span class=\"token operator\">&lt;</span>NSCopying<span class=\"token punctuation\">,</span> NSMutableCopying<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  NSData <span class=\"token operator\">*</span>_content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">@property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> readonly<span class=\"token punctuation\">)</span> NSData <span class=\"token operator\">*</span>content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">@end</span>\n\n<span class=\"token keyword\">@implementation</span> GHBlob\n<span class=\"token keyword\">@synthesize</span> content <span class=\"token operator\">=</span> _content<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">@end</span>\n</code></pre>\n      </div>\n<p>And in the mutable subclass:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token keyword\">@interface</span> GHMutableBlob <span class=\"token punctuation\">:</span> GHBlob\n<span class=\"token keyword\">@property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> readwrite<span class=\"token punctuation\">)</span> NSData <span class=\"token operator\">*</span>content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">@end</span>\n\n<span class=\"token keyword\">@implementation</span> GHMutableBlob\n<span class=\"token keyword\">@dynamic</span> content<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setContent<span class=\"token punctuation\">:</span><span class=\"token punctuation\">(</span>NSData <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>content <span class=\"token punctuation\">{</span>\n  _content <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>content copy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n      </div>","fields":{"slug":"/implementing-a-mutable-subclass-in-objective-c","post":{"title":"Implementing a Mutable Subclass in Objective-C","link":null,"timestamp":"2012-01-06T06:31Z","date":"January 6, 2012 6:31am UTC"}}}},{"node":{"html":"<p>While I was working on unit tests for <a href=\"http://adamstegman.com/projects/git-push.html\">Git Push</a>, I wanted to mock my\ndelegate so I could create an expectation. So I used <a href=\"http://ocmock.org/\">OCMock</a>:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code>id delegate <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>OCMockObject mockForProtocol<span class=\"token punctuation\">:</span><span class=\"token keyword\">@protocol</span><span class=\"token punctuation\">(</span>MyDelegateProtocol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>delegate expect<span class=\"token punctuation\">]</span> someMethod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nmyClassIvar<span class=\"token punctuation\">.</span>connectionDelegate <span class=\"token operator\">=</span> delegate<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">[</span>myClassIvar someOtherMethod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">STAssertNoThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>delegate verify<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">@\"should have called someMethod on delegate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n      </div>\n<p>But found the assertion failing. I stepped into <code>#someOtherMethod</code> and discovered\nthe delegate was nil. So I added</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token function\">STAssertNotNil</span><span class=\"token punctuation\">(</span>myClassIvar<span class=\"token punctuation\">.</span>connectionDelegate<span class=\"token punctuation\">,</span> <span class=\"token string\">@\"should have set delegate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n      </div>\n<p>And watched that fail as well. Since Git Push is using <a href=\"http://developer.apple.com/technologies/ios5/\">ARC</a>, I <a href=\"http://clang.llvm.org/docs/AutomaticReferenceCounting.html#objects\">read up\non retain semantics</a> to see if I was missing something about local\nreferences. But local references are strong, so the delegate should not have\nbeen deallocated yet.</p>\n<p>I <a href=\"http://stackoverflow.com/questions/8675054/why-is-my-objects-weak-delegate-property-nil-in-my-unit-tests\">posted about this issue on Stack Overflow</a> <sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>, where Evan\nsuggested that OCMock may be the issue. Sure enough, creating an explicit class\nconforming to my delegate protocol fixed the issue.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-objectivec\"><code><span class=\"token keyword\">@interface</span> MockDelegate <span class=\"token punctuation\">:</span> NSObject <span class=\"token operator\">&lt;</span>MyDelegateProtocol<span class=\"token operator\">></span>\n<span class=\"token keyword\">@property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> strong<span class=\"token punctuation\">)</span> NSNumber <span class=\"token operator\">*</span>called<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">@end</span>\n<span class=\"token keyword\">@implementation</span> MockDelegate\n<span class=\"token keyword\">@synthesize</span> called <span class=\"token operator\">=</span> _called<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>someMethod <span class=\"token punctuation\">{</span>\n  _called <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>NSNumber numberWithBool<span class=\"token punctuation\">:</span>YES<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">@end</span>\n\n<span class=\"token keyword\">@implementation</span> MyClassTests\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>testSomeOtherMethod <span class=\"token punctuation\">{</span>\n  MockDelegate <span class=\"token operator\">*</span>delegate <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>MockDelegate alloc<span class=\"token punctuation\">]</span> init<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  myClassIvar<span class=\"token punctuation\">.</span>connectionDelegate <span class=\"token operator\">=</span> delegate<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">[</span>myClassIvar someOtherMethod<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">STAssertTrue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>delegate<span class=\"token punctuation\">.</span>called boolValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">@\"should have called someMethod on delegate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">@end</span>\n</code></pre>\n      </div>\n<p>I still don't understand why it was being deallocated, but it was definitely\nrelated to OCMock. I've isolated the issue in <a href=\"https://github.com/adamstegman/ARCMock\">a Github repo</a> to make\nit obvious and repeatable.</p>\n<p>UPDATE: Erik Doernenberg of OCMock looked into the issue and answered the Stack\nOverflow question as well, and determined it's actually an issue with NSProxy\nobjects and ARC in the iOS runtime. It works fine on OS X.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Note that my code is slightly different, as I was using a static helper function to create my mock. I confirmed that was not the issue.</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/nil-weak-reference-to-an-ocmock-mock-object","post":{"title":"Nil Weak Reference to an OCMock Mock Object","link":null,"timestamp":"2012-01-02T21:55Z","date":"January 2, 2012 9:55pm UTC"}}}},{"node":{"html":"<p>Yesterday Nathan Fillion <a href=\"http://twitter.com/NathanFillion/statuses/106853202909073409\">tweeted</a> about finding a permutation of his name on a website. At first I just chuckled, but it soon occurred to me that this would be a fun problem to solve with scripting.</p>\n<p>So I whipped up <a href=\"https://gist.github.com/1174851\">fillion.rb</a> to peruse a webpage for permutations of a given word. It was fun to figure out a quick algorithm to find permutations, and then fight scope creep (I ended up writing a crawler for an entire domain).</p>\n<p>The beauty of development is being able to look for a challenge anywhere.</p>","fields":{"slug":"/fillion-rb","post":{"title":"fillion.rb","link":"https://gist.github.com/1174851","timestamp":"2011-08-27T01:48Z","date":"August 27, 2011 1:48am UTC"}}}},{"node":{"html":"<p>While working on <a href=\"http://adamstegman.com/projects/web-queue.html\">Web Queue</a> today I went to document the URLs to\nhelp me figure out the interface. As I was about to start writing out the URLs,\nI realized I could make it a lot easier on myself by giving the document some\nstructure. So I decided to roll it into the README, which also needed to be\nwritten.</p>\n<p>As I wrote up the README, everything became a bit clearer. Up to that point, I\nhad been fussing over details, learning how to use OAuth and the Netflix API\nwhile poorly maintaining a few different classes. Writing the README allowed me\nto step back and conceive the system as a whole, which made the necessary code\nmuch more clear to me. That's README-driven development.</p>\n<p>My projects often go like this. I'm almost always learning a new technology or\nlibrary, so I can't always start off with a good architecture. But starting\nwith the interface can make things a lot clearer.</p>\n<p>Writing out the URLs for a project is pretty similar to writing the README. It\nhas the same goal, figuring out the interface of a project, but focused on web\napplications instead of any other project. And as I'm learning from personal\nexperience, that can be exactly what's needed for a good project.</p>","fields":{"slug":"/url-driven-development-is-readme-driven-development","post":{"title":"URL-Driven Development is README-Driven Development","link":null,"timestamp":"2011-08-06T19:42Z","date":"August 6, 2011 7:42pm UTC"}}}},{"node":{"html":"<blockquote>\n<p>I am very excited by the Internet and how easy it is today to get a project started.\nCase in point, <a href=\"http://adamstegman.com/\">my new site</a>.</p>\n</blockquote>\n<p>I'm also hosting <a href=\"http://blog.adamstegman.com/\">my blog</a> there now.</p>","fields":{"slug":"/new-site","post":{"title":"New Site","link":"http://adamstegman.com/","timestamp":"2011-08-04T01:56Z","date":"August 4, 2011 1:56am UTC"}}}},{"node":{"html":"<p>I’ve unfortunately been experiencing the magic of Grails lately.</p>\n<p>TIL:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-groovy\"><code><span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</code></pre>\n      </div>\n<p>and</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-groovy\"><code><span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</code></pre>\n      </div>\n<p>but</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-groovy\"><code><span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</code></pre>\n      </div>\n<p>This is so much fun.</p>\n<p>Update: This is due to a non-implementation of <code>JSONArray.hashCode()</code>. JIRA logged here: <a href=\"http://jira.grails.org/browse/GRAILS-7770\">http://jira.grails.org/browse/GRAILS-7770</a></p>","fields":{"slug":"/til-grails-edition","post":{"title":"TIL, Grails edition","link":null,"timestamp":"2011-07-21T17:38Z","date":"July 21, 2011 5:38pm UTC"}}}},{"node":{"html":"<p>Reading code documentation to understand a system is like learning how to drive by inspecting the washer fluid dispenser, then a spark plug, then the brake pads. Write a README.</p>","fields":{"slug":"/write-a-readme","post":{"title":"Write a README","link":null,"timestamp":"2011-07-13T06:09Z","date":"July 13, 2011 6:09am UTC"}}}},{"node":{"html":"<blockquote>\n<p>And, in good conscience, don’t you want to be an idiot when you’re on the other side of the screen? I do! I want to be\nan idiot! Please let me be an idiot. I want things to “just work”.</p>\n</blockquote>\n<p>Completely agree. It's easy to lose sight of this.</p>","fields":{"slug":"/90-percent-of-your-users-are-idiots","post":{"title":"90% of your users are \"idiots\"","link":"http://blog.jitbit.com/2011/06/90-of-your-users-are-idiots.html","timestamp":"2011-06-29T17:56Z","date":"June 29, 2011 5:56pm UTC"}}}},{"node":{"html":"<p>I've written several tests that have the unfortunate side effect of writing to stdout or stderr, polluting my pretty stream of dots.</p>\n<p>Thanks to a <a href=\"http://benevolentcode.com/2011/03/temporarily-redirect-stdout-in-ruby/\">post on Benevolent Code</a>, I decided to silence them (<a href=\"https://gist.github.com/adamstegman/926853\">gist</a>).</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-ruby\"><code>setup <span class=\"token symbol\">:silence_output</span>\n\n<span class=\"token comment\"># Redirects stderr and stdout to /dev/null.</span>\n<span class=\"token keyword\">def</span> silence_output\n  <span class=\"token variable\">@orig_stderr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$stderr</span>\n  <span class=\"token variable\">@orig_stdout</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$stdout</span>\n\n  <span class=\"token comment\"># redirect stderr and stdout to /dev/null</span>\n  <span class=\"token variable\">$stderr</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/dev/null'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token variable\">$stdout</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/dev/null'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\nteardown <span class=\"token symbol\">:enable_output</span>\n\n<span class=\"token comment\"># Replace stdout and stderr so anything else is output correctly.</span>\n<span class=\"token keyword\">def</span> enable_output\n  <span class=\"token variable\">$stderr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@orig_stderr</span>\n  <span class=\"token variable\">$stdout</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@orig_stdout</span>\n  <span class=\"token variable\">@orig_stderr</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span>\n  <span class=\"token variable\">@orig_stdout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span>\n<span class=\"token keyword\">end</span>\n</code></pre>\n      </div>\n<p>Update:</p>\n<p>The same thing in RSpec (<a href=\"https://gist.github.com/926858\">gist</a>):</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-ruby\"><code><span class=\"token constant\">RSpec</span><span class=\"token punctuation\">.</span>configure <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>config<span class=\"token operator\">|</span>\n  config<span class=\"token punctuation\">.</span><span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token symbol\">:all</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token symbol\">:silence_output</span><span class=\"token punctuation\">)</span>\n  config<span class=\"token punctuation\">.</span><span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token symbol\">:all</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token symbol\">:enable_output</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># Redirects stderr and stdout to /dev/null.</span>\n<span class=\"token keyword\">def</span> silence_output\n  <span class=\"token variable\">@orig_stderr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$stderr</span>\n  <span class=\"token variable\">@orig_stdout</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$stdout</span>\n\n  <span class=\"token comment\"># redirect stderr and stdout to /dev/null</span>\n  <span class=\"token variable\">$stderr</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/dev/null'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token variable\">$stdout</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/dev/null'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># Replace stdout and stderr so anything else is output correctly.</span>\n<span class=\"token keyword\">def</span> enable_output\n  <span class=\"token variable\">$stderr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@orig_stderr</span>\n  <span class=\"token variable\">$stdout</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@orig_stdout</span>\n  <span class=\"token variable\">@orig_stderr</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span>\n  <span class=\"token variable\">@orig_stdout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span>\n<span class=\"token keyword\">end</span>\n</code></pre>\n      </div>","fields":{"slug":"/silence-test-unit-tests","post":{"title":"Silence Test::Unit tests","link":null,"timestamp":"2011-04-19T04:20Z","date":"April 19, 2011 4:20am UTC"}}}},{"node":{"html":"<p>I'm working on reading emails sent from ActionMailer, and was noticing the weird form of what I thought was URL-encoding in an HTML section of a multipart email, e.g.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-html\"><code>&lt;html lang=3D\"en\">\n</code></pre>\n      </div>\n<p>I also noticed the line length and endings:</p>\n<blockquote>\n<p>blah blah … blah bl=<br>\nah blah blah</p>\n</blockquote>\n<p>I shrugged these off as quirks of ActionMailer or SMTP and moved on to removing/decoding them.</p>\n<p>Two hours later, when googling for info about them because they didn't seem consistent, I stumbled across <a href=\"http://en.wikipedia.org/wiki/Quoted-printable\">Quoted-printable encoding</a>. I recognized it from the headers in the email, and wondered if someone had written a gem or something to decode it. Then I find <a href=\"http://rubydoc.info/stdlib/core/1.8.7/String#unpack-instance_method\">this</a> - String#unpack was able to do it for me all along.</p>\n<p>It's great that Ruby (and sometimes Rails) can do things like this out of the box. I just wish I was smart enough to look.</p>","fields":{"slug":"/quoted-printable-in-ruby","post":{"title":"Quoted-printable in Ruby","link":null,"timestamp":"2011-02-10T03:31Z","date":"February 10, 2011 3:31am UTC"}}}},{"node":{"html":"<p>I'll admit it. I hate test-driven development while I'm actually doing it. It's boring and tedious. I get lost in details while trying to get some test to work. Maybe I just need to do more <a href=\"http://thecleancoder.blogspot.com/2010/10/craftsman-62-dark-path.html\">katas</a>, but it gets old fast.</p>\n<p>Katas make it look so nice and easy. You just think of the right test, write it, and make it pass. But in practice I have a much bigger picture in mind that I want to implement, and I just can't limit myself to building it one atom at a time, or I'll lose it. Sometimes, I just want to hack.</p>\n<p>So I can sympathize when I see people writing a bunch of code to get some massive feature ready, and then filling in tests at the end. But it's wrong. It seems harmless (\"I'm still testing, right?\") because the difference can be subtle. Writing tests after the fact means you're writing your tests to fit your code, instead of the other way around. You're trying to achieve that code coverage metric instead of thinking hard about each feature, branch, and interface.</p>\n<p>Just like writing code without TDD, it can often work just fine. But it's not scalable and it results in poorly-tested and/or poorly-written code.</p>\n<p>I'm not just preaching, I live this dilemma every day. TDD sucks, but man, does it ever improve the quality of my code.</p>\n<p>Sometimes I just hack. But most of the time, I drop in TODO's where I need to remember a big picture and get to testing first.</p>","fields":{"slug":"/test-driven-drudgery","post":{"title":"Test-Driven Drudgery","link":null,"timestamp":"2011-01-05T21:56Z","date":"January 5, 2011 9:56pm UTC"}}}},{"node":{"html":"<p>I made an about.me page. At the very least, it will be a central repository for where to find me. Hopefully I can get a better background eventually.</p>","fields":{"slug":"/about-me","post":{"title":"About.me","link":"http://about.me/adamstegman","timestamp":"2010-12-03T07:30Z","date":"December 3, 2010 7:30am UTC"}}}},{"node":{"html":"<p>Rails' ActiveRecord has a nifty <code>#destroy</code> method that almost everyone already knows about. The documentation for <code>#destroy</code><sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> helpfully states</p>\n<blockquote>\n<p>Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they\ncan’t be persisted).</p>\n</blockquote>\n<p>What is less clear is how it works when you call it on a relationship. To be sure, it destroyed the database record. What it also unfortunately does it hangs on to the reference in the parent object.</p>\n<p>Let's throw down with some sample code.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-ruby\"><code><span class=\"token keyword\">class</span> <span class=\"token class-name\">Thing</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token symbol\">:Base</span>\n  has_one <span class=\"token symbol\">:child</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Child</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token symbol\">:Base</span>\n  belongs_to <span class=\"token symbol\">:thing</span>\n<span class=\"token keyword\">end</span>\n\nzengarden<span class=\"token operator\">></span> thing <span class=\"token operator\">=</span> <span class=\"token constant\">Thing</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt;Thing id: nil, name: nil, created_at: nil, updated_at: nil></span>\nzengarden<span class=\"token operator\">></span> thing<span class=\"token punctuation\">.</span>save\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token keyword\">true</span>\nzengarden<span class=\"token operator\">></span> thing<span class=\"token punctuation\">.</span>create_child <span class=\"token symbol\">:name</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"Child\"</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt;Child id: 4, name: \"Child\", thing_id: 1,...></span>\nzengarden<span class=\"token operator\">></span> thing<span class=\"token punctuation\">.</span>child\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt;Child id: 4, name: \"Child\", thing_id: 1...></span>\nzengarden<span class=\"token operator\">></span> thing<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>destroy\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt;Child id: 4, name: \"Child\", thing_id: 1...></span>\nzengarden<span class=\"token operator\">></span> thing<span class=\"token punctuation\">.</span>child\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt;Child id: 4, name: \"Child\", thing_id: 1...></span>\n</code></pre>\n      </div>\n<p>Arg. I just destroyed it! I don't want it hanging around in my cache. If I really wanted to save it, I should have saved it before or during the destroy call. I can of course invalidate my cache by calling</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-ruby\"><code>thing<span class=\"token punctuation\">.</span><span class=\"token function\">child</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">true</span><span class=\"token punctuation\">)</span>\n</code></pre>\n      </div>\n<p>which correctly returns nil. But if I don't know to do that immediately after the destroy, I get errors like</p>\n<blockquote>\n<p>TypeError: can't modify frozen hash</p>\n</blockquote>\n<p>because code used later naïvely calls</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-ruby\"><code><span class=\"token keyword\">if</span> thing<span class=\"token punctuation\">.</span>child\n  thing<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">.</span>attributes <span class=\"token operator\">=</span> new_attributes\n<span class=\"token keyword\">end</span>\n</code></pre>\n      </div>\n<p>expecting that if a child exists, it should be updated.</p>\n<p>For the sake of argument, let's say that maybe the behavior isn't so bad, maybe this is what people expect or could use. In that case, what a terrible error message. I'm not familiar enough with the Associations internals to suggest where a better one could be injected, but something along the lines of</p>\n<blockquote>\n<p>Can't modify a destroyed record</p>\n</blockquote>\n<p>would be miles better.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Rails 3 - <a href=\"http://railsapi.com/doc/rails-v3.0.0/classes/ActiveRecord/Persistence.html#M001019\">http://railsapi.com/doc/rails-v3.0.0/classes/ActiveRecord/Persistence.html#M001019</a>\nRails 2.3.8 - <a href=\"http://railsapi.com/doc/rails-v2.3.8/classes/ActiveRecord/Base.html#M001111\">http://railsapi.com/doc/rails-v2.3.8/classes/ActiveRecord/Base.html#M001111</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/activerecord-hangs-on-to-destroyed-relations","post":{"title":"ActiveRecord Hangs On to Destroyed Relations","link":null,"timestamp":"2010-10-25T18:31Z","date":"October 25, 2010 6:31pm UTC"}}}},{"node":{"html":"<p>Version 1.1.0 of Read Link Later now works with New Twitter. Rejoice!</p>\n<p>Sorry for the delay. New Twitter came to me at a bad time, where I didn't have the time to devote to updating Read Link Later. Fortunately, we're in business now!</p>\n<p>The only issue is that the New Twitter uses their own API through JavaScript, so I don't have a way of knowing when a tweet is loaded. To work around this, I look for new tweets to add the Read Later links to every 100 ms. If I could hack in a custom event, that would be something.</p>","fields":{"slug":"/read-link-later-works-with-new-twitter","post":{"title":"Read Link Later Works With New Twitter","link":"https://chrome.google.com/extensions/detail/mffbgadohiiggcibdgmogfdlmackfbhm","timestamp":"2010-10-20T12:27Z","date":"October 20, 2010 12:27pm UTC"}}}},{"node":{"html":"<p><a href=\"http://github.com/thoughtbot/factory_girl\"><code>factory_girl</code></a> is great for DRYing up test code and making tests isolated and maintainable. What it's not so great at is any <a href=\"http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html\">association</a> more complicated than <code>has_one</code>/<code>belongs_to</code>. I found <a href=\"http://stackoverflow.com/questions/2937326/populating-an-association-with-children-in-factory-girl\">a nice trick on Stack Overflow</a> for <code>has_many</code> associations.</p>\n<blockquote>\n<p>The Factory.after_ hooks appear to be the only way to do this successfully.</p>\n</blockquote>\n<p>It's a shame, because it makes it really painful to use factories. What used to be a one-line call to create whatever you need becomes writing your own factories that call <code>factory_girl</code> factories.</p>","fields":{"slug":"/complex-associations-with-factory-girl","post":{"title":"Complex Associations with factory_girl","link":null,"timestamp":"2010-08-18T19:00Z","date":"August 18, 2010 7:00pm UTC"}}}},{"node":{"html":"<p>I'm excited to publish my first Google Chrome extension, Read Link Later. From the detail page:</p>\n<blockquote>\n<p>Read Link Later adds an Instapaper \"Read Later\" link to each tweet in a Twitter.com feed. The link retrieves each external URL in the tweet and adds it to your Instapaper queue for reading later.</p>\n</blockquote>\n<p>Unfortunately I can't add these links to clients, that would be even more helpful.</p>","fields":{"slug":"/read-link-later","post":{"title":"Read Link Later","link":"https://chrome.google.com/extensions/detail/mffbgadohiiggcibdgmogfdlmackfbhm","timestamp":"2010-08-16T04:35Z","date":"August 16, 2010 4:35am UTC"}}}},{"node":{"html":"<p><a href=\"http://iwasamonkey.tumblr.com/post/915222642/happiness\">iwasamonkey</a>:</p>\n<blockquote>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 370px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 345.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCABFABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIDBAH/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAez3OrKZjK8tM2UDozQdIl5PZz1NHpJBIr//xAAdEAACAQQDAAAAAAAAAAAAAAABAgADESAhEiIy/9oACAEBAAEFAr5tLxdt6EPUAzjKhu0VtYKTj//EABURAQEAAAAAAAAAAAAAAAAAACAR/9oACAEDAQE/ATT/AP/EABcRAAMBAAAAAAAAAAAAAAAAAAAQESD/2gAIAQIBAT8BVKpn/8QAGhAAAQUBAAAAAAAAAAAAAAAAMAABESAxUf/aAAgBAQAGPwITrBxyv//EAB4QAAMAAQUBAQAAAAAAAAAAAAABESEQQVFhcTGB/9oACAEBAAE/ITUVclG8FG2NF45opXueiYP20j3oTKsXaEn6P9mE4Nh/Eu4/aWaMJsuj50WlP//aAAwDAQACAAMAAAAQ6+qDKw8//A//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREg/9oACAEDAQE/EIQaIN16f//EABkRAAIDAQAAAAAAAAAAAAAAAAERABAgQf/aAAgBAgEBPxBxwUAIV7j/xAAgEAEAAwABBAMBAAAAAAAAAAABABEhMUFRYXGBkaGx/9oACAEBAAE/EDuJ5p40+ETmlyneAaRuJonI91KmOfMdLVIx2RQ6WB+2V46Mu4xNfEHPa4M1soPVJyLM1Oj1KcpVjbNWuWIyhTLIpYv1Nsrp0j1i2vlv7BsmSWcBRXeZ4/s//9k='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Happiness\"\n        title=\"\"\n        src=\"/static/336082001386c47b498ecc3d2928bd6b/f2c47/happiness.jpg\"\n        srcset=\"/static/336082001386c47b498ecc3d2928bd6b/cdfcb/happiness.jpg 240w,\n/static/336082001386c47b498ecc3d2928bd6b/f2c47/happiness.jpg 370w\"\n        sizes=\"(max-width: 370px) 100vw, 370px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>Happiness</p>\n</blockquote>","fields":{"slug":"/happiness","post":{"title":"Happiness","link":null,"timestamp":"2010-08-07T03:17Z","date":"August 7, 2010 3:17am UTC"}}}},{"node":{"html":"<p><a href=\"http://onethingwell.org/post/898477013/gobolinux\">onethingwell</a>:</p>\n<blockquote>\n<blockquote>\n<p>GoboLinux is a modular Linux distribution: it organizes the programs in your system in a new, logical way. Instead of\nhaving parts of a program thrown at <code>/usr/bin</code>, other parts at <code>/etc</code> and yet more parts thrown\nat <code>/usr/share/something/or/another</code>, <em>each program gets its own directory tree</em>, keeping them all neatly separated\nand allowing you to see everything that’s installed in the system and which files belong to which programs in a\nsimple and obvious way.</p>\n</blockquote>\n<p>Off-topic, I know, but this strikes me as an eminently sensible approach.</p>\n</blockquote>\n<p>Sounds like what OS X does with applications. Very sensible.</p>","fields":{"slug":"/gobolinux","post":{"title":"GoboLinux","link":"http://www.gobolinux.org/","timestamp":"2010-08-03T15:19Z","date":"August 3, 2010 3:19pm UTC"}}}},{"node":{"html":"<p>The more I think about this, the more this statement bothers me. <a href=\"http://twitter.com/tavon\">@tavon</a> said that grid layouts like <a href=\"http://960.gs/\">960 grid</a> are as bad as table layouts. His reasoning was that the classes are purely presentational; it's presentation affecting markup the same way tables used to.</p>\n<p>But that's just misuse of the layouts. You shouldn't pull something massive and generic like a grid layout and not modify it to suit your website. Wouldn't you modify your reset stylesheet to match the styles your website uses? Use your existing class names instead of the presentational grid class names, and remove the classes you don't need. These third party tools are not holy relics - change them to what you need!</p>\n<p>That doesn't mean they can't or don't affect markup inappropriately. I haven't used a grid layout, so I'm not familiar with what's required. But the generated styles aren't inherently bad, they just need to be adapted.</p>","fields":{"slug":"/grid-layout-as-bad-as-table-layout","post":{"title":"Grid Layout As Bad As Table Layout?","link":null,"timestamp":"2010-07-17T05:06Z","date":"July 17, 2010 5:06am UTC"}}}},{"node":{"html":"<p>UPDATE: After deleting and re-cloning RubyAMP, I was able to edit the shortcut. All good!</p>\n<p>I've had to uninstall <a href=\"http://code.leadmediapartners.com/\">RubyAMP</a>, a TextMate bundle that I use several times a day, because it overrode Ctrl+B and refused to let me change it.</p>\n<p>I realize most people don't use these shortcuts, so I'll explain it. Ctrl+B moves the cursor back one character, the equivalent of the left arrow key without having to move your hands. My workflow uses Ctrl+B so constantly that I couldn't live with RubyAMP anymore, even though I enjoy its functionality.</p>\n<p>The reason this is so negative is the fact that Ctrl+B is not a shortcut that I added; it's part of OS X. If you are creating keyboard shortcuts for your program or extension, you can't possibly avoid stepping on every other program's toes. But the least you can do is avoid stepping on the operating system's toes. Otherwise it's just negligent, user-hostile design.</p>","fields":{"slug":"/dont-override-system-shortcuts","post":{"title":"Don't Override System Shortcuts","link":null,"timestamp":"2010-06-29T14:31Z","date":"June 29, 2010 2:31pm UTC"}}}},{"node":{"html":"<blockquote>\n<p>This viral ad for <em>Civilization V</em> about people trying to kick their <em>Civ</em> habit will probably just make you want to\npick the game up again.</p>\n</blockquote>\n<p>Wow, it's almost like that's what they intended.</p>\n<p><a href=\"http://www.escapistmagazine.com/news/view/101565-Civ-Anonymous-Where-You-Go-to-Stop-Taking-Another-Turn\">Source</a></p>","fields":{"slug":"/thanks-captain-obvious","post":{"title":"Thanks, Captain Obvious","link":null,"timestamp":"2010-06-22T20:43Z","date":"June 22, 2010 8:43pm UTC"}}}},{"node":{"html":"<p>Mark asserts that while using onclick is frowned upon, it's faster and cleaner:</p>\n<blockquote>\n<p>Sure it makes your XHTML a bit longer, but that’s one less selector jQuery has to parse and one less DOMReady function\nyour browser has to kick off.</p>\n</blockquote>\n<p>That's <em>true</em>, but it comes at the cost of maintainability. Putting the jQuery example he provided into an external file makes it easier to maintain by having all the JavaScript in predictable and findable places.</p>\n<p>Additionally, that performance hit can be mitigated by using progressive enhancement to give the entire page functionality immediately, then asynchronously loading the JavaScript to enhance it. Asynchronously loading your JS may or may not even be necessary, depending on your JS payload.</p>\n<p>Using inline code like this isn't necessary for most people; they just make your code harder to read.</p>","fields":{"slug":"/onclick-is-your-friend","post":{"title":"onclick is Your Friend","link":"http://thenerdary.net/articles/entry/onclick-is-your-friend","timestamp":"2010-06-21T23:00Z","date":"June 21, 2010 11:00pm UTC"}}}},{"node":{"html":"<blockquote>\n<p>You know what would annoy the shit out of me if I were using a screen reader to read a bibliography on the internet?\nListening to a goofy-sounding computer voice try to emphasize every single word of <em>Journal of the Study of Obscure\nand Mostly-in-Latin Canine Diseases Affecting Generally the Respiratory System but Also Sometimes the Lymph Nodes</em> or\nsomething. I don’t know that this is still a problem, but the idea is ridiculous in and of itself. Italic does not\nalways mean emphasis, nor does bold always mean MAKE THIS LOUD.</p>\n</blockquote>\n<p>Hey, you know, that's true. That's what <code>&#x3C;b></code> and <code>&#x3C;i></code> should be used for. Here's what they <em>shouldn't</em> be used for, from the same article:</p>\n<blockquote>\n<p>The bold and italic tags are short. The emphasis tag isn’t bad, but the strong tag is way too long to be a good value\nper keystroke.</p>\n</blockquote>\n<p>Yeah, semantic HTML uses tags that are longer than one character. <code>&#x3C;strong></code> is five whole more letters than <code>&#x3C;b></code>! Sounds like someone who throws around a lot of \"u\"instead of \"you\", and \"y\" instead of \"why\" in textual conversations. Not someone I'd want to take design advice from.</p>\n<blockquote>\n<p>I add <code>&#x3C;b></code> and <code>&#x3C;i></code> to things I don’t necessarily want bolded or italicized. I do it because they’re some of the\nshortest elements available and they provide a hook to style child elements in larger repeated widgets with very\nprecise, complex layouts. If I have to wrap every word of text in a tag just to accomplish some goofy layout, I’m\nusing the smallest thing available.</p>\n</blockquote>\n<p>That sounds like a pretty poor layout.</p>\n<p>Bottom line is, <code>&#x3C;b></code> and <code>&#x3C;i></code> have their place, but it's not showing emphasis, nor is it saving keystrokes or because this layout is kinda complicated and I want some easy hooks.</p>","fields":{"slug":"/defending-terrible-things","post":{"title":"Defending Terrible Things","link":"http://garann.wordpress.com/2010/06/19/defending-terrible-things/","timestamp":"2010-06-20T05:14Z","date":"June 20, 2010 5:14am UTC"}}}},{"node":{"html":"<p>And no one wants to put in that much work.</p>","fields":{"slug":"/comments-are-hard-work","post":{"title":"Comments are hard work.","link":"http://powazek.com/posts/1063","timestamp":"2010-06-17T15:13Z","date":"June 17, 2010 3:13pm UTC"}}}},{"node":{"html":"<p>The top-voted comments here are a great example of why people are agreeing with <a href=\"http://daringfireball.net/2010/06/whats_fair\">John Gruber's assessment of comments</a>.</p>\n<blockquote>\n<p>What makes DF an efficient and effective soapbox is exactly that it is <em>not</em> noisy.\nMy goal is for not a single wasted word to appear anywhere on any page of the site.</p>\n</blockquote>\n<p>Those comments distract from the article with fiery, irrelevant rants that show the authors didn't even RTFA. The whole point of the article is lost if you start reading them.</p>","fields":{"slug":"/this-is-why-we-cant-have-nice-things","post":{"title":"This is why we can't have nice things.","link":"http://blogs.hbr.org/bregman/2010/06/why-i-returned-my-ipad.html","timestamp":"2010-06-17T15:08Z","date":"June 17, 2010 3:08pm UTC"}}}}]},"site":{"siteMetadata":{"title":"My Kind of Stupid"}}},"pageContext":{}}